"use strict";jQuery.fn.extend({insertAtCaret:function(a){return this.each(function(e){if(document.selection)this.focus(),document.selection.createRange().text=a,this.focus();else if(this.selectionStart||0===this.selectionStart){let b=this.selectionStart,c=this.selectionEnd,d=this.scrollTop;this.value=this.value.substring(0,b)+a+this.value.substring(c,this.value.length),this.focus(),this.selectionStart=b+a.length,this.selectionEnd=b+a.length,this.scrollTop=d}else this.value+=a,this.focus()})}}),window.IL=[],window.tables=[];let _=window._,B=window.Backbone;$.widget("il.typeahead",{searchId:"",ignoredKeys:[9,13,16,17,18,20,27,33,34,35,36,37,38,39,40,45],options:{delay:300,minLength:0,source:""},_getCreateOptions:function(){return{delay:this.element.attr("data-delay"),minLength:this.element.attr("data-minLength"),source:this.element.attr("data-source")}},_create:function(){this._on(this.element,{input:this._search,focus:this._search});let a=this.element.parent().next();this._on(a,{"click button":function(a){this.element.val($(a.target).text()).attr("data-id",$(a.target).attr("data-id")),this._clearMenus(),this._trigger("onSelect",null,{element:this.element})}}),this._on(a,{"keyup button":function(a){a.stopPropagation(),38===a.which&&$(a.target).prev().focus(),40===a.which&&$(a.target).next().focus(),27===a.which&&(this.element.focus(),this._clearMenus())}}),this._on("body",{click:this._clearMenus}),this._on(this.element.closest(".typeahead"),{click:function(a){a.stopPropagation()}}),this._on(this.window,{resize:this._resizeMenus})},_search:function(a){return 9===a.which||40===a.which?($(".typeahead").find("button:first").focus(),!1):(27===a.which&&this._clearMenus(),this.element.val().length<this.options.minLength)?(this._clearMenus(),!1):-1===this.ignoredKeys.indexOf(a.which)&&void(clearTimeout(this.searchId),this.searchId=this._delay(this._load,this.options.delay))},_load:function(){let b=this,a=this.element,c=a.parent().next();$.when(model.load({url:this.options.source,data:{q:this.element.val()}})).done(function(d){if(""===d.html){b._clearMenus();return}c.width(a.outerWidth()-2).show().prev().attr("aria-expanded",!0);let e=new Popper(a[0],c[0],{placement:"bottom",eventsEnabled:!0,positionFixed:!0,modifiers:{preventOverflow:{enabled:!1},hide:{enabled:!1}}});c.html(d.html),e.update()})},_clearMenus:function(){$(".typeahead .dropdown-menu").hide().empty().prev().attr("aria-expanded",!1)},_resizeMenus:function(){$(".typeahead .dropdown-menu").each(function(){$(this).width($(this).parent().outerWidth()-2)})}}),$.widget("il.filterable",{event:"",searchStr:"",searchId:"",options:{container:"",minLength:1,source:"",targets:""},_getCreateOptions:function(){return{container:this.element.attr("data-container"),minLength:this.element.attr("data-minLength"),source:this.element.attr("data-source"),targets:this.element.attr("data-targets")}},_create:function(){this._on(this.element,{input:$.proxy(this,"_filter")}),this._addClass("filterable")},_filter:function(a){if(this.event=a,this.element.val()===this.searchStr)return!1;this.searchStr=this.element.val(),this.searchStr.replace("=","").length<this.options.minLength&&(this.searchStr=""),clearTimeout(this.searchId),""!==this.options.source&&""!==this.options.container?this.searchId=this._delay(this._remoteSearch,400):""!==this.options.targets&&(this.searchId=this._delay(this._localSearch,200))},_localSearch:function(){let a=this._escapeRegexp(this.searchStr),b=new RegExp(a,"ui"),c=new RegExp("("+a+")","gui");0===a.indexOf("=")&&(b=new RegExp("^"+a.substring(1),"ui"),c=new RegExp("^("+a.substring(1)+")","gui")),this.searchStr.length>=this.options.minLength?($(this.options.targets).addClass("d-none"),$(this.options.targets).filter(function(){let a=$(this),d=a.text(),e=b.test(d);return!0===e&&a.html(d.replace(c,'<mark class="px-0">$1</mark>')),e}).removeClass("d-none")):$(this.options.targets).removeClass("d-none").each(function(){let a=$(this);a.html(a.text())}),this._trigger("complete",this.event)},_remoteSearch:function(){let a=this,b=this.options.source,c=this.options.container;$.when(model.load({url:b,data:{q:a.searchStr}})).done(function(b){$(c).replaceWith(b.html),a._trigger("complete",a.event)})},_escapeRegexp:function(a){let b=new RegExp("[\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]","gui");return a.replace(b,"\\$&")}}),$.widget("il.expandable",{table:'<div class="il-expandable"></div>',cell1:'<div class="il-expandable-left">                 <button class="btn btn-sm btn-secondary" aria-controls="">                     <span class="mdi mdi-chevron-right"></span>                 </button>             </div>',cell2:'<div class="il-expandable-right" aria-expanded="true"></div>',_create:function(){this._expandability(),this._on(this.window,{resize:this._expandability})},_expandability:function(){if(this.element.innerHeight()>40&&0===this.element.find(".il-expandable-left").length){this.element.wrapInner(this.cell2).wrapInner(this.table),this.element.children().prepend(this.cell1);let a="il-expandable-"+this.uuid;this.element.find(".il-expandable-left").find("button").attr("aria-controls",a),this.element.find(".il-expandable-right").attr("id",a).attr("aria-expanded","false").addClass("text-truncate"),this._on(this.element,{"click .il-expandable-left > button":this._toggle})}},_toggle:function(){this.element.find(".il-expandable-left").find(".mdi").toggleClass("mdi-chevron-right mdi-chevron-down"),this.element.find(".il-expandable-right").toggleClass("text-truncate").attr("aria-expanded",function(b,a){return"false"===a?"true":"false"})}}),$.widget("il.clonable",{options:{target:""},_create:function(){""!==this.options.target&&(this._addClass($(this.options.target),"clonable-target-"+this.uuid),this._on(this.element,{click:this._clone}),this._on(this.element.next(".remove-clone-button"),{click:this._removeClone}))},_clone:function(){let b=$(this.options.target),c="clonable-target-"+this.uuid,a=b.clone();b.removeAttr("id"),a.find("[id]").each(function(){let b=$(this).attr("id"),c=_.uniqueId();$(this).attr("id",b+"-"+c),a.find('[for="'+b+'"]').attr("for",b+"-"+c)}),a.find("[name]").each(function(){let a=$(this).attr("name").replace(/\[(\d+)]/,function(b,a){return"["+(parseInt(a)+1)+"]"});$(this).attr("name",a)}),a.find('[type="text"], [type="number"]').each(function(){this.value=""}),a.insertAfter($("."+c).last()),formStyle.init(),this._trigger("onClone",null,{clonedTarget:a[0]})},_removeClone:function(){let a="clonable-target-"+this.uuid,b=$("."+a),c=b.last(),d=c.attr("id");b.length<2||(c.remove(),$("."+a).last().attr("id",d))}}),$.widget("il.confirmable",{options:{target:"#modal-confirm",title:"Confirmation",body:"Confirm?",button:"Yes",submit:function(){}},_getCreateOptions:function(){return{target:this.element.data("target"),title:this.element.data("title"),body:this.element.data("body"),button:this.element.data("button")}},_create:function(){this._on(this.element,{click:this._modal})},_modal:function(){let c=this,a=$(this.options.target),b=a.find(".modal-footer > button").eq(0);a.find(".modal-title").html(this.options.title),a.find(".modal-body").html(this.options.body),a.find(".modal-footer > button").eq(0).html(this.options.button),formStyle.init(),a.modal("show"),$(b).off("click").on("click",function(b){c._trigger("submit",b),a.modal("hide")})}}),$.widget("il.saveable",{_create:function(){"form"===this.element.get(0).nodeName.toLowerCase()&& void 0!==this.element.attr("id")&&(this._on(this.element,{save:this.save}),this.load())},save:function(){let c=this.element,a=[],b=this.element.serializeArray();_.forEach(b,function(b,d){"hidden"!==c.find('input[name="'+b.name+'"]').attr("type")&&a.push({name:b.name,value:b.value})}),store.save("saveable."+this.element.attr("id"),a)},load:function(){let b=0,c=this,a=store.load("saveable."+this.element.attr("id"))||[];this.element.get(0).reset(),this.element.find(":checkbox").prop("checked",!1),_.forEach(a,function(a){let d=c.element.find("[name='"+a.name+"']");0===d.length&&b<3&&(c.element.find(".clone-button").trigger("click"),b++,d=c.element.find("[name='"+a.name+"']")),d.val([a.value])}),formStyle.updateForm(this.element)},saveParams:function(a){store.save("saveable."+this.element.attr("id"),a)}}),$.widget("il.uploadable",{options:{multiple:!1,maxFiles:1e3},maxFilesMessage:"Maximum number of files reached.",maxSizeMessage:"File <b>{{filename}}</b> exceeds the size limit of {{limit}} MB.",fileItem:`<div data-file="{{filename}}">
                   <div class="text-truncate">
                        {{filename}}
                   </div>
                   <div class="progress rounded-0 mb-2 bg-darker-5" style="height: 4px">
                       <div class="progress-bar" role="progressbar" style="width: 1%" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100"></div>
                   </div>
               </div>`,_getCreateOptions:function(){return{multiple:!0===this.element.find(":file").prop("multiple")}},_create:function(){void 0===IL.uploader&&(IL.uploader={}),this._on(this.element,{submit:this._submit}),this._on(this.element.find(".uploadable-url"),{keydown:this._urlSubmit}),this._on(this.element.find(".uploadable-clear"),{click:this._clearFiles}),this._on(this.element.find(":file"),{change:this._pdfTitle});let a=this,b=this.element.find(".uploadable-select"),d=this.element.find(".uploadable-clear"),e=this.element.find(".uploadable-list"),c=Math.min(window.MAX_UPLOAD,window.MAX_POST),f=0,g=0;IL.uploader[this.uuid]=new window.ss.SimpleUpload({button:b,url:a.element.attr("action"),name:a.element.find(":file").attr("name"),form:a.element,responseType:"json",overrideSubmit:!1,maxSize:c/1024,multiple:a.options.multiple,multipleSelect:a.options.multiple,autoSubmit:!1,dropzone:a.element,dragClass:"outline-standout",onChange:function(g,h,i,c,b){if(!1===a.options.multiple&&this.clearQueue(),this.getQueueSize()>=a.options.maxFiles)return $.jGrowl(a.maxFilesMessage,{header:"Info",sticky:!1,theme:"bg-primary"}),!1;a._addFile(b),f+=c,e.children("div").eq(0).removeClass("d-none"),d.removeClass("d-none"),"application/pdf"===b.type&&a._pdfTitle(b)},onSubmit:function(b){this.setProgressContainer(a.element.find('div[data-file="'+_.escape(b)+'"]')),this.setProgressBar(a.element.find('div[data-file="'+_.escape(b)+'"] .progress-bar'))},onSizeError:function(b,d){let e=a.maxSizeMessage.replace(/{{filename}}/,_.escape(b)).replace(/{{limit}}/,c/1048576);$.jGrowl(e,{header:"Info",sticky:!1,theme:"bg-primary"}),f-=d,this.getQueueSize()>0&&this.submit()},onDone:function(d,e,h,i,j,c){let b=100*(g+=c)/f;a.element.find(".uploadable-progress .progress-bar").attr("aria-valuenow",b).css("width",b+"%"),this.getQueueSize()>0&&this.submit()},onAllDone:function(){this.destroy(),$.jGrowl("Upload has finished.",{header:"Info",theme:"bg-primary"}),B.history.loadUrl()},onError:function(e,f,a,b,c){let d={status:a,statusText:b,responseJSON:JSON.parse(c)};model._onFail(d),this.getQueueSize()>0&&this.submit()}})},_addFile:function(a){let b=this.fileItem.replace(/{{filename}}/g,_.escape(a.name)),c=this.element.find(".uploadable-list").find(".list-group-item").eq(1).children();!0===this.options.multiple?c.append(b):c.html(b),this.element.find(".uploadable-list").removeClass("d-none"),this._trigger("change",null,a)},_submit:function(a){a.preventDefault(),"object"==typeof IL.uploader[this.uuid]&&IL.uploader[this.uuid].getQueueSize()>0?IL.uploader[this.uuid].submit():$.when(model.save({url:this.element.attr("action"),data:this.element.serialize()})).done(function(){B.history.loadUrl()})},_urlSubmit:function(a){if(13===a.which)return this.element.trigger("submit"),!1},_clearFiles:function(){this.element.find(".uploadable-list").addClass("d-none"),this.element.find(".uploadable-list").find(".list-group-item").eq(1).children().empty(),this.element.find(".uploadable-clear").addClass("d-none"),IL.uploader[this.uuid].clearQueue(),this._trigger("clear")},_pdfTitle:function(a){if("function"!=typeof this.options.pdftitles)return!1;if(a.size>5242880)return this._trigger("pdftitles",null,{titles:[]}),!1;let d=this,b=new FileReader,c=function(){let g=b.result,h=new RegExp(/<dc:title[\s\S]+?\/dc:title>/g),e,a=[],f=0;for(;e=h.exec(g);){let i=$(e[0]);a[f]=$.trim(i.text()),f++}let j=0===(a=a.filter(Boolean)).length?[]:a;d._trigger("pdftitles",null,{titles:j}),b.removeEventListener("load",c),b=null};b.addEventListener("load",c),b.readAsText(a)}}),$.jGrowl.defaults.pool=3,$.jGrowl.defaults.life=5e3,$.jGrowl.defaults.position="top-right",$.jGrowl.defaults.closeTemplate='<span class="mdi mdi-window-close" aria-label="Close alert"></span>',$.jGrowl.defaults.closerTemplate="<button>CLOSE ALL</button>";class Overlay{constructor(){this.delay=800,this.timeId=null,this.template=`<div id="overlay" class="d-flex align-items-center" style="display:none" aria-hidden="true">
                             <span class="mx-auto mdi mdi-orbit mdi-spin text-danger"></span>
                         </div>`}start(a){let b=this;return"number"==typeof this.timeId&&this.stop(),a="number"==typeof a?a:this.delay,this.timeId=setTimeout(function(){let a=$("#overlay");0===a.length&&($("body").append(b.template),a.fadeIn(250,function(){}))},a),!0}stop(){let a=$("#overlay");return clearTimeout(this.timeId),this.timeId=null,a.length>0&&a.fadeOut(150,function(){a.remove()}),!0}}let overlay=new Overlay;class LocalStore{save(b,a){if(null==a||"function"==typeof a)return!1;localStorage.setItem(b,this._serialize(a))}load(a){return this._unserialize(localStorage.getItem(a))}delete(a){localStorage.removeItem(a)}clear(){localStorage.clear()}_serialize(a){return JSON.stringify(a)}_unserialize(a){return JSON.parse(a)}}let store=new LocalStore;class SessionStore{save(b,a){if(null==a||"function"==typeof a)return!1;sessionStorage.setItem(b,this._serialize(a))}load(a){return this._unserialize(sessionStorage.getItem(a))}delete(a){sessionStorage.removeItem(a)}clear(){sessionStorage.clear()}_serialize(a){return JSON.stringify(a)}_unserialize(a){return JSON.parse(a)}}let sessionStore=new SessionStore;class FormStyle{init(){let a=this;$(":checkbox, :radio").each(function(){a.updateStyle($(this))}).off("change.formstyle").on("change.formstyle",function(){a.changeState($(this))}).off("focus.formstyle").on("focus.formstyle",function(){$(this).next().find(".label-text").css("text-decoration","underline dotted 1px")}).off("blur.formstyle").on("blur.formstyle",function(){$(this).next().find(".label-text").css("text-decoration","none")})}changeState(a){let b=this;$('input[name="'+a.attr("name")+'"]').each(function(){b.updateStyle($(this))})}updateStyle(a){let b=a.next().find(".mdi");"radio"===a.attr("type")?!0===a.prop("checked")?b.removeClass("mdi-radiobox-blank").removeClass("text-muted").addClass("mdi-radiobox-marked text-primary"):b.removeClass("mdi-radiobox-marked").removeClass("text-primary").addClass("mdi-radiobox-blank text-muted"):"checkbox"===a.attr("type")&&(!0===a.prop("checked")?b.removeClass("mdi-checkbox-blank-outline").removeClass("text-muted").addClass("mdi-checkbox-marked text-primary"):b.removeClass("mdi-checkbox-marked").removeClass("text-primary").addClass("mdi-checkbox-blank-outline text-muted"))}updateForm(a){let b=this;a.find(":checkbox, :radio").each(function(){b.updateStyle($(this))})}}let formStyle=new FormStyle;class Keyboard{init(){let a=$("#keyboard-window");if(!0===a.hasClass("d-lg-block")){a.removeClass("d-lg-block");return}a.addClass("d-lg-block"),0===a.length&&$.when(model.load({url:window.IL_BASE_URL+"index.php/keyboard"})).done(function(b){$("body").append(b.html);let a=$("#keyboard-window");a.position({my:"bottom",at:"bottom",of:"body"}),$(window).off("resize.keyboard").on("resize.keyboard",function(){a.position({my:"bottom",at:"bottom",of:"body"})}),a.draggable({handle:".card-header",containment:"body"}),a.find(".close").off("click.keyboard").on("click.keyboard",function(){a.removeClass("d-lg-block")}),a.find(".tab-content").on("mousedown",function(){return!1}),$("#keyboard").on("click",".btn",function(){let a=$(this).html();1===$("#notes-ta_ifr").length?tinymce.execCommand("mceInsertContent",!1,a):$(":focus").insertAtCaret(a).trigger("input")})})}}let keyboard=new Keyboard;class ExportForm{init(){let a=decodeURIComponent($("#open-export").data("exportUrl")).indexOf("index.php/summary")>0?"summary":"items",b=$("#modal-export");""===$.trim(b.find(".modal-body").html())&&$.when(model.load({url:window.IL_BASE_URL+"index.php/"+a+"/exportform"})).done(function(a){b.find(".modal-body").append(a.html),formStyle.init(),$("#export-form").saveable(),b.find(".modal-footer button:first-child").off("click").on("click",function(){exportform.formSubmit()}),$("#export-styles").typeahead(),$("#export-styles").off("focus").on("focus",function(){b.find('[name="export"]').val(["citation"]),formStyle.updateForm($("#export-form"))})})}formSubmit(){let a=decodeURIComponent($("#open-export").data("exportUrl")),b=$("#export-form"),c=""===new URL(a).search?"?":"&";window.open(a+c+b.serialize()),b.saveable("save")}}let exportform=new ExportForm;class OmnitoolForm{init(){let a=$("#modal-omnitool");if(""===$.trim(a.find(".modal-body").html()))$.when(model.load({url:window.IL_BASE_URL+"index.php/items/omnitoolform"})).done(function(b){a.find(".modal-body").append(b.html),formStyle.init(),a.find(".modal-footer button:first-child").on("click",function(){omnitoolform.formSubmit()}),$("#tag-filter-omnitool").filterable({complete:function(){$("#omnitool-tags .label-text").each(function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")}),$("#omnitool-tags .tag-table").find("tr").each(function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")})}})});else{let b=a.find("form");b[0].reset(),formStyle.updateForm(b)}}formSubmit(){let a=decodeURIComponent($("#open-omnitool").data("omnitoolUrl")),b=$("#modal-omnitool").find("form");$("#modal-omnitool").modal("hide"),$.when(model.save({url:a,data:b.serialize()})).done(function(){B.history.loadUrl()})}}let omnitoolform=new OmnitoolForm;class QuickSearch{init(){let b=this,a=$("#quick-search-form");a.off("submit").on("submit",function(a){a.preventDefault(),b.formSubmit()}),$("#modal-quick-search .modal-footer").find("button.search-submit").off("click").on("click",function(){b.formSubmit()}),a.saveable()}formSubmit(){let b=$("#modal-quick-search"),a=$("#quick-search-form"),c=new URL("http://foo.bar/"+a.attr("action").substr(1)),d=""===c.search?"?":"&";a.saveable("save"),router.navigate(a.attr("action")+d+a.serialize(),{trigger:!0}),b.modal("hide")}}let quicksearch=new QuickSearch;class AdvancedSearch{init(){let b=this,a=$("#advanced-search-form");a.off("submit").on("submit",function(a){a.preventDefault(),b.formSubmit()}),$("#modal-advanced-search .modal-footer").find("button.search-submit").off("click").on("click",function(){b.formSubmit()}),$("#advanced-search-form .clone-button").clonable({target:"#clone-target",onClone:function(b,a){$(a.clonedTarget).find("select.fields").trigger("change")}}),a.saveable(),a.on("change","select.fields",this.hideBooleans),this.hideBooleans(),$("#tag-filter-search").filterable({complete:function(){$("#search-tags .label-text").each(function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")}),$("#search-tags .tag-table").find("tr").each(function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")})}})}formSubmit(){let b=$("#modal-advanced-search"),a=$("#advanced-search-form"),c=new URL("http://foo.bar/"+a.attr("action").substr(1)),d=""===c.search?"?":"&";a.saveable("save"),router.navigate(a.attr("action")+d+a.serialize(),{trigger:!0}),b.modal("hide")}hideBooleans(a){let c,b=void 0===a?$("#advanced-search-form").find("select.fields"):$(this);$.each(b,function(b,a){switch($(a).val()){case"AU":case"T1":case"T2":case"T3":case"KW":case"YR":case"C1":case"C2":case"C3":case"C4":case"C5":case"C6":case"C7":case"C8":c=!0;break;default:c=!1}c?$(a).closest(".row").removeClass("text-search").addClass("string-search"):$(a).closest(".row").removeClass("string-search").addClass("text-search")})}}let advancedsearch=new AdvancedSearch;class SearchList{init(){$("#modal-searches").on("show.bs.modal",searchlist.load)}load(a){let b=$("#modal-searches");$.when(model.load({url:window.IL_BASE_URL+"index.php/search/list",async:!0})).done(function(a){b.find(".modal-body").html(a.html),b.find(".modal-body").on("click",".delete-search",searchlist.deleteSearch)})}deleteSearch(b){let a=$(this);$.when(model.save({url:a.data("url"),data:{id:a.data("id")}})).done(function(){searchlist.load()})}}let searchlist=new SearchList;class Sidebar{init(){let e=this,a=$("#side-menu"),f=$(".navbar-toggler");$(window).on("popstate",function(){let c=location.hash.split("?")[0],b=a.find('a[href^="'+c+'"]');if(0!==b.length){if(a.find("a").removeClass("clicked"),""===location.hash||"#"===location.hash)return!0;e.expandSidebar(b)}}),a.metisMenu();let c=location.hash.split("?")[0],b=a.find('a[href^="'+c+'"]');if(0===b.length){let d=_.dropRight(location.hash.split("/"));b=a.find('a[href="'+d+'"]')}this.expandSidebar(b),a.on("click","a",function(){location.hash===$(this).attr("href")&&B.history.loadUrl(),""!==$(this).attr("href")&&"#"!==$(this).attr("href")&&f.is(":visible")&&f.trigger("click")})}expandSidebar(a){a.parents("ul.collapse").not(".in").each(function(){$(this).addClass("in").prev().click()}),a.addClass("clicked")}}let sidebar=new Sidebar;class ImageFilter{constructor(){this.touchDevice=window.matchMedia("(max-width: 1199px)").matches,this.default={contrast:"1",brightness:"1",saturation:"1",hue:"0deg",invert:"0",sharpen:!1,sharpness:"0"}}compileCss(c){let a=$(".pdfviewer-right > div:first").hasClass("img-night-mode"),d=$("#adjust-contrast").val()||this.default.contrast,e=$("#adjust-brightness").val()||this.default.brightness,f=$("#adjust-saturation").val()||this.default.saturation,g=$("#adjust-sharpness").val()||this.default.sharpness,b=`contrast(${d}) brightness(${e}) saturate(${f}) hue-rotate(${a?"180deg":"0deg"}) invert(${a?"1":"0"})`;return!0===c&&"0"!==g&&(b+=" url(#sharpen)"),b}adjustFilter(a){this.touchDevice||$(".pdfviewer-right img").slice(Math.max(a-3,0),a+3).css("filter",this.compileCss(!0))}adjustSharpness(c){if(this.touchDevice)return;let a=$("#sharpen feConvolveMatrix"),b=a.attr("kernelMatrix").split(" ");b[4]=-12*parseFloat($("#adjust-sharpness").val())+16,a.attr("kernelMatrix",b.join(" ")),this.adjustFilter(c)}disableSharpening(a){this.touchDevice||$(".pdfviewer-right img").slice(Math.max(a-3,0),a+3).css("filter",this.compileCss(!1))}reset(a){this.touchDevice||($("#adjust-contrast").val(this.default.contrast),$("#adjust-brightness").val(this.default.brightness),$("#adjust-saturation").val(this.default.saturation),$("#adjust-sharpness").val(this.default.sharpness),this.adjustSharpness(a))}lightMode(){$(".pdfviewer-left img").css("filter","hue-rotate(0deg) invert(0)"),$(".pdfviewer-right img").css("filter",this.compileCss(!0))}nightMode(){$(".pdfviewer-left img").css("filter","hue-rotate(180deg) invert(1)"),$(".pdfviewer-right img").css("filter",this.compileCss(!0))}}let imageFilter=new ImageFilter,arxiv={url:"https://export.arxiv.org/api/query?start=0&max_results=1&id_list=",metadata:function(e){let a={author_last_name:[],author_first_name:[],keywords:[],uid_types:[],uids:[],secondary_title:"eprint"},b=e.find("entry");a.reference_type="article",a.title=b.children("title").text().replace(/\r?\n|\r/g," ")||"",a.abstract=b.children("summary").text().replace(/\r?\n|\r/g," ")||"";let f=new Date(b.children("published").text().replace(/\r?\n|\r/g," "));a.publication_date=f.toISOString().substr(0,10);let c=b.children("arxiv\\:doi").text().replace(/\r?\n|\r/g," ")||"";if(""!==c&&(a.uid_types.push("DOI"),a.uids.push(c)),1===b.find("id").length){a.uid_types.push("ARXIV");let d=b.find("id").text().replace(/https?:\/\/arxiv\.org\/abs\//,"");a.uids.push(d),$(".uploadable-url").val("https://arxiv.org/pdf/"+d)}return _.forEach(b.find("name"),function(d,b){let c=$(d).text().split(" ");a.author_last_name[b]=c.pop(),a.author_first_name[b]=c.join(" ")}),_.forEach(b.children("category"),function(b,c){a.keywords[c]=$(b).attr("term")}),JSON.stringify(a)}},views={};B.emulateJSON=!0;let Router=B.Router.extend({routes:{":controller(/:action)(?:query)":"dispatch"},dispatch:function(a,b,c){let d="string"==typeof a?a:"main",e="string"==typeof b?b:"main";$.when(model.load({url:window.IL_BASE_URL+"index.php/"+d+"/"+e+("string"==typeof c?"?"+c:"")})).done(function(a){"object"==typeof views[d+e]?views[d+e].render(a):console.error('The view "'+(d+e)+'" does not exist.')})}}),router=new Router;class Model{constructor(){this.xhr="",this.options={url:null,data:void 0,async:!1,cors:!1,dataType:"json"}}load(a){return a=_.assign({},this.options,a),this._request("GET",a.url,a.data,a.async,a.cors,a.dataType)}save(a){return a=_.assign({},this.options,a),this._request("POST",a.url,a.data,a.async,a.cors,a.dataType)}_request(c,d,e,f,g,h){let k=this,i=$.Deferred(),a=!0!==f;!0===a&&"object"==typeof this.xhr&&this.abort();let b={"X-Client-Width":screen.width};!0===g&&(b={});let j=$.ajax({url:d,data:e,type:c,dataType:h||"json",headers:b}).done(function(a){k._onSuccess(a),i.resolve(a)}).fail(function(a){k._onFail(a,g),i.reject(a)});return!0===a&&(overlay.start(),model.xhr=j),i}abort(){"object"==typeof this.xhr&&(this.xhr.abort(),this.xhr="",overlay.stop())}_onSuccess(a){this.xhr="",overlay.stop(),"string"==typeof a.info&&$.jGrowl(a.info,{header:"Info",sticky:!1,theme:"bg-primary"})}_onFail(a,b){if(this.xhr="",overlay.stop(),!1===b|| void 0===b){if("abort"===a.statusText);else if(401===a.status){let c=window.IL_BASE_URL+"?ref="+window.btoa(location.href);location.replace(c)}else if(404===a.status)location.replace(window.IL_BASE_URL+"index.php/notfound/main");else if(a.status>400&&a.status<500){let d=void 0!==a.responseJSON?a.responseJSON.error:"Unspecified error.";$.jGrowl(d,{header:"Info",sticky:!1,theme:"bg-primary"})}else{let e=void 0!==a.responseJSON?a.responseJSON.error:"Unspecified error.";$.jGrowl(e,{header:a.status+" "+a.statusText,sticky:!0,theme:"bg-danger"})}}}}let model=new Model;class View{constuctor(){this.events={},this.parent=""}render(a){let b=$(this.parent);return 1!==b.length?(console.error('The view container "'+this.parent+'" not found!'),!1):("string"==typeof a.title&&(document.title=a.title),"string"==typeof a.html&&(b.html(a.html),this.delegateEvents(),"function"==typeof window.MathJax.typeset&&window.MathJax.typeset(),this.afterRender(a)),$(".modal").modal("hide"),$(".modal-backdrop").remove(),$('[data-toggle="tooltip"], .tooltip').tooltip("hide"),this)}htmlRender(){for(let b in this.events){let a=this.events[b];_.isFunction(a)||(a=this[a]);let c=b.match(/^(\S+)\s*(.*)$/);$("body").on(c[1]+".view",c[2],{object:this},a)}formStyle.init(),"function"==typeof window.MathJax.typeset&&window.MathJax.typeset(),this.afterRender()}afterRender(a){}delegateEvents(){if(void 0===this.events)return this;for(let b in this.undelegateEvents(),this.events){let a=this.events[b];_.isFunction(a)||(a=this[a]);let c=b.match(/^(\S+)\s*(.*)$/);$(this.parent).on(c[1]+".view",c[2],{object:this},a)}return this}undelegateEvents(){return 1===$(this.parent).length&&$(this.parent).off(".view"),this}}class DashboardMainView extends View{constructor(){super(),this.parent="#content-col"}afterRender(a){formStyle.init(),quicksearch.init(),advancedsearch.init(),sessionStore.delete("il.idList")}}views.dashboardmain=new DashboardMainView;class SettingsMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #user-settings-form":"saveForm"}}afterRender(a){formStyle.init(),$("#timezones").typeahead(),$("#modal-settings").find(".modal-body").html("")}saveForm(b){b.preventDefault();let a=$(this);a.find(":checkbox").each(function(){!1===$(this).prop("checked")&&a.append(`<input type="hidden" name="${$(this).attr("name")}" value="0">`)}),$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){location.reload()})}}views.settingsmain=new SettingsMainView;class ProfileMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #user-profile-form":"saveProfile","submit #user-profile-change-password":"savePassword"}}afterRender(a){$('[data-toggle="tooltip"]').tooltip({container:"#content-col"})}saveProfile(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){let a=""===$("#first_name").val()?$("#username").val():$("#first_name").val();$("#menu-first-name").text(a)})}savePassword(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){a[0].reset()})}}views.profilemain=new ProfileMainView;class ItemsMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .open-filter-local":"filterLocal","click .open-filter-remote":"filterRemote","click .clipboard":"clipboard","click .project":"project","click #open-export":exportform.init,"click #open-omnitool":omnitoolform.init}}afterRender(a){formStyle.init();let b=this;this.itemsHeight(),$(window).off("resize.ItemsMainView").on("resize.ItemsMainView",function(){b.itemsHeight()}),quicksearch.init(),advancedsearch.init(),sessionStore.save("il.idList",a.id_list),this.highlightSearch()}itemsHeight(){let a=$("#bottom-row").outerHeight();$(".navbar-toggler").is(":visible")?$("#top-row").height($(window).height()-a-$(".navbar-toggler").outerHeight(!0)-(1===$("#filter-list").length?$("#filter-list").outerHeight(!0):0)):$("#top-row").height($(window).height()-a)}filterLocal(){let a=$(this).data("src"),b=$(this).data("title");$.when(model.load({url:a})).done(function(a){$("#modal-filters .modal-title").html(b),$("#modal-filters .modal-body .container-fluid").replaceWith(a.html),$("#modal-filters").modal(),$("#modal-filters .modal-body").on("click","a",function(){$("#modal-filters").modal("hide")}),$("#modal-filters .filterable").filterable("destroy"),$("#modal-filters :text").filterable({targets:"#modal-filters a"}).val("").focus()})}filterRemote(){let a=$(this).data("src"),b=$(this).data("title");$.when(model.load({url:a})).done(function(c){$("#modal-filters .modal-title").html(b),$("#modal-filters .modal-body .container-fluid").replaceWith(c.html),$("#modal-filters").modal(),$("#modal-filters .modal-body").on("click","a",function(){$("#modal-filters").modal("hide")}),$("#modal-filters .filterable").filterable("destroy"),$("#modal-filters :text").filterable({source:a,container:"#modal-filters .container-fluid"}).val("").focus()})}clipboard(){let a=$(this),b=a.closest(".item-container").data("id"),c=!0===a.prop("checked")?"add":"delete";$.when(model.save({url:window.IL_BASE_URL+"index.php/clipboard/"+c,data:{id:b}})).fail(function(){a.prop("checked",!a.prop("checked")),formStyle.changeState(a)}).done(function(b){!0===b.max_count&&(a.prop("checked",!a.prop("checked")),formStyle.changeState(a))})}project(){let a=$(this),b=a.closest(".item-container").data("id"),c=a.val(),d=!0===a.prop("checked")?"additem":"deleteitem";$.when(model.save({url:window.IL_BASE_URL+"index.php/project/"+d,data:{id:b,project_id:c}})).fail(function(){a.prop("checked",!a.prop("checked")),formStyle.changeState(a)}).done(function(b){!0===b.max_count&&(a.prop("checked",!a.prop("checked")),formStyle.changeState(a))})}highlightSearch(){if(location.hash.indexOf("search_query")> -1&&$(".item-container").length>0){let d=new URL("http://foo.bar/"+location.hash.substr(1));document.designMode="on";var a=window.getSelection();for(let c of d.searchParams)if(0===c[0].indexOf("search_query")){let e=c[1].split(" ");for(let b of e)if(a.collapse(document.getElementsByClassName("item-container")[0],0),(b=b.replace("*","").replace("%2A","")).length>1)for(;window.find(b,!1);)document.execCommand("hiliteColor",!1,"#ffff9bbf"),document.execCommand("foreColor",!1,"#222426")}a.collapseToEnd(),document.designMode="off",a.removeAllRanges(),$("#top-row").scrollTop(0)}}}views.itemsmain=new ItemsMainView,views.itemsfilter=new ItemsMainView;class ItemsCatalogView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .open-filter-local":views.itemsmain.filterLocal,"click .open-filter-remote":views.itemsmain.filterRemote,"click .clipboard":"clipboard","click .project":"project","click #open-export":exportform.init,"click #open-omnitool":omnitoolform.init}}afterRender(a){views.itemsmain.afterRender(a)}clipboard(){let a=$(this),b=a.closest(".item-container").data("id"),c=!0===a.prop("checked")?"add":"delete";$.when(model.save({url:window.IL_BASE_URL+"index.php/clipboard/"+c,data:{id:b}})).fail(function(){a.prop("checked",!a.prop("checked")),formStyle.changeState(a)}).done(function(b){!0===b.max_count&&(a.prop("checked",!a.prop("checked")),formStyle.changeState(a))})}project(){let a=$(this),b=a.closest(".item-container").data("id"),c=a.val(),d=!0===a.prop("checked")?"additem":"deleteitem";$.when(model.save({url:window.IL_BASE_URL+"index.php/project/"+d,data:{id:b,project_id:c}})).fail(function(){a.prop("checked",!a.prop("checked")),formStyle.changeState(a)}).done(function(b){!0===b.max_count&&(a.prop("checked",!a.prop("checked")),formStyle.changeState(a))})}}views.itemscatalog=new ItemsCatalogView;class ClipboardMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .open-filter-local":views.itemsmain.filterLocal,"click .open-filter-remote":views.itemsmain.filterRemote,"click .clipboard":"clipboard","click .project":"project","click #open-export":exportform.init,"click #open-omnitool":omnitoolform.init}}afterRender(a){views.itemsmain.afterRender(a)}clipboard(){let a=$(this),b=a.closest(".item-container").data("id"),c=!0===a.prop("checked")?"add":"delete";$.when(model.save({url:window.IL_BASE_URL+"index.php/clipboard/"+c,data:{id:b}})).done(function(){B.history.loadUrl()}).fail(function(){a.prop("checked",!a.prop("checked")),formStyle.changeState(a)})}project(){let a=$(this),b=a.closest(".item-container").data("id"),c=a.val(),d=!0===a.prop("checked")?"additem":"deleteitem";$.when(model.save({url:window.IL_BASE_URL+"index.php/project/"+d,data:{id:b,project_id:c}})).fail(function(){a.prop("checked",!a.prop("checked")),formStyle.changeState(a)}).done(function(b){!0===b.max_count&&(a.prop("checked",!a.prop("checked")),formStyle.changeState(a))})}}views.clipboardmain=new ClipboardMainView,views.clipboardfilter=new ClipboardMainView;class ProjectsMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #project-form":"submitForm","click .join":"joinProject","click .leave":"leaveProject","click .activate":"activateProject","click .inactivate":"inactivateProject"}}afterRender(a){formStyle.init(),$('[data-toggle="tooltip"]').tooltip(),$(".delete").confirmable({submit:function(){$.when(model.save({url:window.IL_BASE_URL+"index.php/project/delete",data:{project_id:$(this).data("projectId")}})).done(function(){B.history.loadUrl()})}}),$("#filter-active").filterable({targets:".active-project",complete:function(){$(".active-project-container").removeClass("d-none"),$(".active-project.d-none").closest(".active-project-container").addClass("d-none")}}),$("#filter-open").filterable({targets:".open-project",complete:function(){$(".open-project-container").removeClass("d-none"),$(".open-project.d-none").closest(".open-project-container").addClass("d-none")}}),$("#filter-inactive").filterable({targets:".inactive-project",complete:function(){$(".inactive-project-container").removeClass("d-none"),$(".inactive-project.d-none").closest(".inactive-project-container").addClass("d-none")}})}submitForm(a){let b=a.data.object;a.preventDefault(),$.when(model.save({url:$(this).attr("action"),data:$(this).serialize()})).done(function(a){$("#content-col").html(a.html),b.afterRender()})}joinProject(){$.when(model.save({url:window.IL_BASE_URL+"index.php/project/join",data:{project_id:$(this).data("projectId")}})).done(function(){B.history.loadUrl()})}leaveProject(){$.when(model.save({url:window.IL_BASE_URL+"index.php/project/leave",data:{project_id:$(this).data("projectId")}})).done(function(){B.history.loadUrl()})}activateProject(){$.when(model.save({url:window.IL_BASE_URL+"index.php/project/activate",data:{project_id:$(this).data("projectId")}})).done(function(){B.history.loadUrl()})}inactivateProject(){$.when(model.save({url:window.IL_BASE_URL+"index.php/project/inactivate",data:{project_id:$(this).data("projectId")}})).done(function(){B.history.loadUrl()})}}views.projectsmain=new ProjectsMainView;class ProjectBrowseView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .open-filter-local":views.itemsmain.filterLocal,"click .open-filter-remote":views.itemsmain.filterRemote,"click .clipboard":"clipboard","click .project":"project","click #open-export":exportform.init,"click #open-omnitool":omnitoolform.init}}afterRender(a){formStyle.init(),views.itemsmain.afterRender(a)}clipboard(){let a=$(this),b=a.closest(".item-container").data("id"),c=!0===a.prop("checked")?"add":"delete";$.when(model.save({url:window.IL_BASE_URL+"index.php/clipboard/"+c,data:{id:b}})).fail(function(){a.prop("checked",!a.prop("checked")),formStyle.changeState(a)})}project(){let a=$(this),b=a.closest(".item-container").data("id"),c=a.val(),d=!0===a.prop("checked")?"additem":"deleteitem";$.when(model.save({url:window.IL_BASE_URL+"index.php/project/"+d,data:{id:b,project_id:c}})).fail(function(){a.prop("checked",!a.prop("checked")),formStyle.changeState(a)}).done(function(b){!0===b.max_count&&(a.prop("checked",!a.prop("checked")),formStyle.changeState(a)),B.history.loadUrl()})}}views.projectbrowse=new ProjectBrowseView,views.projectfilter=new ProjectBrowseView;class ProjectEditView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #project-form":"submitForm"}}afterRender(a){formStyle.init(),$("#content-col").find('[data-toggle="tooltip"]').tooltip()}submitForm(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){B.history.loadUrl()})}}views.projectedit=new ProjectEditView;class ProjectDiscussionView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #message-form":"bindForm"}}afterRender(a){}bindForm(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){B.history.loadUrl()})}}views.projectdiscussion=new ProjectDiscussionView;class ProjectNotesView extends View{constructor(){super(),this.parent="#content-col",this.events={}}afterRender(a){}}views.projectnotes=new ProjectNotesView,views.projectcompilenotes=new ProjectNotesView;class TagsManageView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit .edit-tag-form":"editTag","submit #tag-form":"createTag"}}editTag(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){B.history.loadUrl()})}createTag(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){B.history.loadUrl()})}}views.tagsmanage=new TagsManageView;class NormalizeMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"change #select-metadata":"changeSource","submit .edit-form":"submitForm"}}afterRender(b){let a=$("#search-metadata");a.filterable({source:a.attr("data-source"),container:a.attr("data-container")})}changeSource(b){b.data.object;let a=$("#search-metadata"),c=window.IL_BASE_URL+"index.php/normalize/search"+$(this).val();a.filterable("destroy"),$("#results").empty(),a.attr("data-source",c).val(""),a.filterable({source:a.attr("data-source"),container:a.attr("data-container")})}submitForm(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()}))}}views.normalizemain=new NormalizeMainView;class NormalizeResultsView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit .edit-form":"submitForm"}}submitForm(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){B.history.loadUrl()})}}views.normalizeauthors=new NormalizeResultsView,views.normalizeeditors=new NormalizeResultsView,views.normalizeprimary=new NormalizeResultsView,views.normalizesecondary=new NormalizeResultsView,views.normalizetertiary=new NormalizeResultsView;class DuplicatesMainView extends View{constructor(){super(),this.parent="#content-col"}}views.duplicatesmain=new DuplicatesMainView;class DuplicatesFindView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit .merge-form":"merge"}}afterRender(a){formStyle.init()}merge(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){a.closest(".card").remove()})}}views.duplicatesfind=new DuplicatesFindView;class ReindexMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click #reindex":"reindex","click #defragment":"defragment","click #check-fts":"integrityFts","click #check-db":"integrityDb","click #reextract":"reextract"}}integrityFts(){$.when(model.load({url:window.IL_BASE_URL+"index.php/reindex/checkfts"}))}integrityDb(){$.when(model.load({url:window.IL_BASE_URL+"index.php/reindex/checkdb"}))}defragment(){$.when(model.load({url:window.IL_BASE_URL+"index.php/reindex/defragment"})).done(function(){B.history.loadUrl()})}reindex(){$.when(model.load({url:window.IL_BASE_URL+"index.php/reindex/reindex"})).done(function(){B.history.loadUrl()})}reextract(){$.when(model.load({url:window.IL_BASE_URL+"index.php/reindex/reextract"})).done(function(){B.history.loadUrl()})}}views.reindexmain=new ReindexMainView;class SummaryMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .clipboard":"clipboard","click .project":"project","click #open-export":exportform.init,"submit .form-uid":"submitForm","click .open-notes":"openNotes","click .rescan-pdf":"rescanPdf","click .update-key":"updateKey"}}afterRender(e){formStyle.init(),$(".truncate").expandable();let f=this;this.itemHeight(),$(window).off("resize.SummaryMainView").on("resize.SummaryMainView",function(){f.itemHeight()}),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink()),$("#delete-item").confirmable({submit:function(){$.when(model.save({url:window.IL_BASE_URL+"index.php/item/delete",data:{id:$("body").data("id")}})).done(function(){location.assign(window.IL_BASE_URL+"index.php#dashboard/main")})}});let b=new URL("http://foo.bar/"+location.hash.substring(1)).searchParams.get("id")||"";$("body").attr("data-id",b).data("id",b),$("a.add-id-link").each(function(){let a=$(this).attr("href").split("id=");$(this).attr("href",a[0]+"id="+b)});let a=sessionStore.load("il.idList");if(a){let c=a[a.indexOf(a.find(a=>a.id===b))-1],d=a[a.indexOf(a.find(a=>a.id===b))+1];void 0===c?$("#summary-previous").addClass("disabled").attr("tabindex","-1").attr("aria-disabled","true"):$("#summary-previous").attr("href","#summary?id="+c.id),void 0===d?$("#summary-next").addClass("disabled").attr("tabindex","-1").attr("aria-disabled","true"):$("#summary-next").attr("href","#summary?id="+d.id)}else $("#summary-next, #summary-previous").remove();$("#autoupload-doi-form").saveable()}itemHeight(){let a=$("#bottom-row").outerHeight();$(".navbar-toggler").is(":visible")?$("#top-row").height($(window).height()-a-$(".navbar-toggler").outerHeight(!0)):$("#top-row").height($(window).height()-a)}clipboard(){let a=$(this),b=$("body").data("id"),c=!0===a.prop("checked")?"add":"delete";$.when(model.save({url:window.IL_BASE_URL+"index.php/clipboard/"+c,data:{id:b}})).fail(function(){a.prop("checked",!a.prop("checked")),formStyle.changeState(a)}).done(function(b){!0===b.max_count&&(a.prop("checked",!a.prop("checked")),formStyle.changeState(a))})}project(){let a=$(this),b=$("body").data("id"),c=a.val(),d=!0===a.prop("checked")?"additem":"deleteitem";$.when(model.save({url:window.IL_BASE_URL+"index.php/project/"+d,data:{id:b,project_id:c}})).fail(function(){a.prop("checked",!a.prop("checked")),formStyle.changeState(a)}).done(function(b){!0===b.max_count&&(a.prop("checked",!a.prop("checked")),formStyle.changeState(a))})}submitForm(b){let a=$(this);b.preventDefault(),$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){B.history.loadUrl()}),$("#autoupload-doi-form").trigger("save")}openNotes(){null!==window.tinymce.activeEditor&& !0===window.tinymce.activeEditor.initialized?$("#notes-window").removeClass("d-none"):views.summarymain.loadNotes()}loadNotes(){let b=this,a=$("body").attr("data-id");$.when(model.load({url:window.IL_BASE_URL+"index.php/notes/user",data:{id:a}})).done(function(c){$("#notes-ta").val(c.user.note),$("#id-hidden").val(a),b.initNotes()})}initNotes(){if(null!==window.tinymce.activeEditor&& !0===window.tinymce.activeEditor.initialized){window.tinymce.activeEditor.load();return}window.tinymce.init({theme:"silver",selector:"#notes-ta",content_css:window.IL_BASE_URL+"css/style.css",resize:"both",min_height:300,menubar:!1,plugins:"importcss save lists advlist link image code fullscreen table searchreplace",toolbar1:"save undo redo fullscreen code | formatselect link unlink image table searchreplace",toolbar2:"bold italic underline strikethrough subscript superscript removeformat | forecolor backcolor | outdent indent bullist numlist",save_onsavecallback:function(b){let a=$("#note-form");$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){$("#user-note").html(b.getContent()),"function"==typeof window.MathJax.typeset&&window.MathJax.typeset()})},image_description:!1,relative_urls:!1,remove_script_host:!1,image_dimensions:!1,image_class_list:[{title:"Auto width",value:"mce-img-fluid"}],image_list:window.IL_BASE_URL+"index.php/supplements/imagelist?as=json&id="+$("body").data("id")}).then(function(){let a=$("#notes-window");a.removeClass("d-none"),a.position({my:"left bottom",at:"left bottom",of:"#content-col"}),$(window).off("resize.notes").on("resize.notes",function(){a.position({my:"left bottom",at:"left bottom",of:"#content-col"})}),a.draggable({handle:".card-header",containment:"body"}),a.find(".close").off("click.notes").on("click.notes",function(){$("#notes-window").addClass("d-none")})})}rescanPdf(){let a=$(this).data("url");$.when(model.load({url:a})).done(function(){B.history.loadUrl()})}updateKey(){$.when(model.save({url:$(this).data("url"),data:{id:$(this).data("id")}})).done(function(){B.history.loadUrl()})}}views.summarymain=new SummaryMainView;class NotesMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .open-notes":views.summarymain.openNotes}}afterRender(){let a=new URL("http://foo.bar/"+location.hash.substring(1)).searchParams.get("id")||"";$("body").attr("data-id",a).data("id",a),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink())}}views.notesmain=new NotesMainView;class EditMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #edit-form":"bindForm","change #reference-type":"bindReferenceType"}}afterRender(a){this.uploadFormWidgets(),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink())}bindForm(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){B.history.loadUrl()})}bindReferenceType(){$("#edit-form").trigger("submit")}uploadFormWidgets(){let a=this;$("input.input-typeahead").each(function(){let b=$(this);b.typeahead({source:b.data("source"),onSelect:function(){a._selectAuthor(this)}})}),$("#clone-authors").clonable({target:"#new-author-container",onClone:function(d,c){let b=$(c.clonedTarget).find(".input-typeahead");b.typeahead({source:b.data("source"),onSelect:function(){a._selectAuthor(this)}})}}),$("#clone-editors").clonable({target:"#new-editor-container",onClone:function(d,c){let b=$(c.clonedTarget).find(".input-typeahead");b.typeahead({source:b.data("source"),onSelect:function(){a._selectAuthor(this)}})}}),$("#clone-uid").clonable({target:"#uid-row"})}_selectAuthor(a){if($(a).is("[name^='author_last_name']")){let d=$(a).closest(".form-row").find('input[name^="author_first_name"]'),b=$(a).val().split(",");$(a).val($.trim(b[0]||"")),d.val($.trim(b[1]||""))}if($(a).is("[name^='editor_last_name']")){let e=$(a).closest(".form-row").find('input[name^="editor_first_name"]'),c=$(a).val().split(",");$(a).val($.trim(c[0]||"")),e.val($.trim(c[1]||""))}}}views.editmain=new EditMainView;class ItemdiscussionMainView extends View{constructor(){super(),this.parent="#content-col",this.messagesId="",this.events={"submit #message-form":"bindForm"}}afterRender(a){this.messagesId=setInterval(this.refreshMessages,1e4),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink())}bindForm(a){a.preventDefault();let c=a.data.object,b=$(this);$.when(model.save({url:b.attr("action"),data:b.serialize()})).done(function(){c.refreshMessages(),b.get(0).reset()})}refreshMessages(){if(0===$("#message-list").length){clearInterval(this.messagesId);return}let a=$("body").data("id");$.when(model.load({url:window.IL_BASE_URL+"index.php/itemdiscussion/messages?id="+a})).done(function(a){$("#message-list").html(a.html),$("#message").val("")})}}views.itemdiscussionmain=new ItemdiscussionMainView;class TagsItemView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #tag-form":"createTags","change .tag-inputs":"changeTags"}}afterRender(a){formStyle.init(),$("#tag-filter").filterable({complete:function(){$("#content-col .label-text").each(function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")}),$(".tag-table").find("tr").each(function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")})}}),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink())}createTags(a){a.preventDefault();let c=a.data.object,b=$(this);""!==$("#new_tags").val()&&$.when(model.save({url:b.attr("action"),data:b.serialize()})).done(function(a){$("#content-col").html(a.html),c.afterRender()})}changeTags(){let a=$(this),b=$("body").data("id");a.is(":checked")?$.when(model.save({url:window.IL_BASE_URL+"index.php/tags/additem",data:{id:b,tag_id:a.val()}})).fail(function(){a.prop("checked",!1),formStyle.updateStyle(a)}):$.when(model.save({url:window.IL_BASE_URL+"index.php/tags/deleteitem",data:{id:b,tag_id:a.val()}})).fail(function(){a.prop("checked",!0),formStyle.updateStyle(a)})}}views.tagsitem=new TagsItemView;class SupplementsMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .rename-file":"renameFile","keydown input.form-control":"submitInput"}}afterRender(a){formStyle.init(),$("#upload-form").uploadable({maxFiles:64}),$(".delete-file").confirmable({submit:function(){let a=$(this).closest("li").find(".filename-link").text().trim(),b=$("body").data("id");$.when(model.save({url:window.IL_BASE_URL+"index.php/supplements/delete",data:{id:b,filename:a}})).done(function(){B.history.loadUrl()})}}),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink())}renameFile(){let a=$(this).closest("li").find(".filename-link"),b=$(this).closest("li").find("input");if(a.hasClass("d-none")){let c=$.trim(a.text()),d=$.trim(b.val());$.when(model.save({url:window.IL_BASE_URL+"index.php/supplements/rename",data:{id:$("body").data("id"),filename:c,newname:d}})).done(function(){B.history.loadUrl()})}else a.addClass("d-none"),b.removeClass("d-none").addClass("d-inline-block").val($.trim(a.text())).focus()}submitInput(a){13===a.which&&$(this).closest(".list-group-item").find(".rename-file").trigger("click")}}views.supplementsmain=new SupplementsMainView;class PdfMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"change #pdfviewer-zoom":"selectZoom","input #pdfviewer-page-input":"inputPageNum","click #pdfviewer-first":"buttonPageNum","click #pdfviewer-prev":"buttonPageNum","click #pdfviewer-next":"buttonPageNum","click #pdfviewer-last":"buttonPageNum","click .pdfviewer-thumb":"thumbPageNum","click #pdfviewer-image":"toggleCropper","click #copy-image-btn":"getCroppedImage","click #save-image-btn":"saveCroppedImage","click #pdfviewer-left-btn":"toggleLeft","click #pdfviewer-previews-btn":"showThumbs","click #pdfviewer-bookmarks-btn":"showBookmarks","click #pdfviewer-results-btn":"showResults","click #pdfviewer-bookmarks a":"clickBookmark","click #pdfviewer-night-btn":"nightMode","click #pdfviewer-text-btn":"toggleTextLayer","click .highlight-color":"addHighlights","click .highlight-eraser":"eraserInit","click #pdfviewer-annot-menu .annot-show":"showAnnotations","click #pdfviewer-annot-menu .annot-hide":"hideAnnotations","click .highlight-cancel":"clearHighlights","dblclick .pdfviewer-page":"dblZoom","keyup #pdfviewer-search-input":"search","click #pdfviewer-results > .pdfviewer-results-container > a":"scrollToResult","click #pdfviewer-result-up":"prevResult","click #pdfviewer-result-down":"nextResult","click #pdfviewer-notes-btn":"showNotes","click .note-edit-btn":"editNote","submit .note-form":"saveNote","submit #new-note-form":"saveNote","click #pdfviewer-new-note-btn":"createNewNote","click .pdflink":"openLink","change #pdfviewer-underlined":"highlightStyle"}}afterRender(f){this.selectable=void 0,this.page=void 0,this.sseSearch=void 0;let a=this;if(this.throttledZoom=_.throttle(function(b){a.pageZoom(b)},500,{leading:!0,trailing:!0}),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink()),0===$("#pdfviewer-pages").length)return;"underlined"===store.load("il.highlightStyle")&&$("#pdfviewer-underlined").prop("checked",!0),formStyle.init(),$("#content-col").find('[data-toggle="tooltip"]').tooltip();let b=new URL(location.href).searchParams.get("id")||"";""!==b&&$("body").attr("data-id",b).data("id",b),$(window).off("resize.PdfMainView").on("resize.PdfMainView",function(){a.pagesHeight(),a.pageZoom(store.load("il.pageZoom")||"auto"),$(".pdfviewer-right").trigger("scroll")}),this.pagesHeight(),new LazyLoad({container:$("#pdfviewer-pages .pdfviewer-left").get(0),elements_selector:".lazy",load_delay:250,threshold:400}),this.lazyLoad=new LazyLoad({container:document.querySelector(".pdfviewer-right"),elements_selector:".lazy",load_delay:250,threshold:1e3}),!0===store.load("il.nightMode")&&$("#pdfviewer-night-btn").click(),!0===store.load("il.leftPanel")&&(this.showLeft(),this.showThumbs()),this.pageZoom(store.load("il.pageZoom")||"auto"),$("#adjust-sharpness").val(imageFilter.default.sharpness),$(".pdfviewer-right").off("scroll").on("scroll",_.throttle(function(){a.redrawNoteLine(),a.redrawSnippetLine(),imageFilter.disableSharpening(a.page),clearTimeout($.data(window,"scrollTimer")),$.data(window,"scrollTimer",setTimeout(function(){$(".pdfviewer-right > div").each(function(){return!a.detectVisiblePage(this,this.getBoundingClientRect(),$(".pdfviewer-right")[0].getBoundingClientRect())}),"object"==typeof a.selectable&&a.selectable.refresh(),imageFilter.adjustSharpness(a.page)},200))},20)),$(".pdfviewer-left").off("scroll").on("scroll",_.throttle(function(){a.redrawNoteLine(),a.redrawSnippetLine()},20)),"object"==typeof a.selectable&&(a.selectable.disable(),a.selectable.destroy()),"object"==typeof a.cropper&&a.destroyCropper();let c={},d=$.Event("keyup");null!==(c=location.hash.length>1?new URL("http://foo.bar/"+location.hash.substring(1)).searchParams:new URL(location.href).searchParams).get("search")&&(d.which=13,$("#pdfviewer-search-input").val(c.get("search")).trigger(d));let e=c.get("page")||$("#pdfviewer-page-input").val();this.setPageNumber(e),this.scrollToPage(e,0),this.getLinks()}selectZoom(a){a.data.object.throttledZoom($(this).val())}dblZoom(b){let a=store.load("il.pageZoom");if("auto"===a){let c=$(".pdfviewer-right").width()-30,d=.5*$(".pdfviewer-page > img").eq(0).attr("width"),e=100*c/d;[50,75,100,125,150,200,250,300].forEach(function(b){b<=e&&(a=b.toString())})}else a="auto";b.data.object.pageZoom(a)}pageZoom(a){"screen"===a&&(a="auto");let c=this.page,b;if($("#pdfviewer-zoom").val(a),store.save("il.pageZoom",a),"auto"===a){let d=$(".pdfviewer-right").width()-30,e=$(".pdfviewer-page > img").eq(0).attr("width"),f=Math.max(100*d/e,50);[50,75,100,125,150,200,250,300].forEach(function(b){b<=f&&(a=b.toString())})}switch(a){case"50":case"100":case"200":default:b="200";break;case"125":case"250":b="250";break;case"75":case"150":case"300":b="300"}$(".pdfviewer-page > img").each(function(){this.style.width=Math.ceil(.01*a*this.getAttribute("width"))+"px",this.style.height=Math.ceil(.01*a*this.getAttribute("height"))+"px",null!==this.getAttribute("data-src")&&(this.removeAttribute("data-was-processed"),this.classList.remove("loaded"),this.setAttribute("data-src",this.getAttribute("data-src").replace(/zoom=\d+/,"zoom="+b)))}),this.lazyLoad.update(),this.scrollToPage(c,0)}pagesHeight(){let a=$("#pdfviewer-menu").outerHeight();$(".navbar-toggler").is(":visible")?$("#pdfviewer-pages, .pdfviewer-left, .pdfviewer-right").height($(window).height()-a-$(".navbar-toggler").outerHeight(!0)):$("#pdfviewer-pages, .pdfviewer-left, .pdfviewer-right").height($(window).height()-a)}detectVisiblePage(c,b,a){return(b.top-a.top>0&&b.top-a.top<a.height/2||a.bottom-b.bottom>0&&a.bottom-b.bottom<a.height/2||a.top-b.top>0&&b.bottom-a.bottom>0)&&(this.setPageNumber($(c).data("page")),!0)}setPageNumber(a){let b=this;b.page!==parseInt(a)&&(b.page=parseInt(a),void 0!==this.pageTimer&&clearTimeout(this.pageTimer),this.pageTimer=_.delay(function(){$("#pdfviewer-page-input").val(a),$(".pdfviewer-thumb").children("div").removeClass("bg-primary").addClass("bg-secondary"),$(".pdfviewer-thumb").eq(a-1).children("div").removeClass("bg-secondary").addClass("bg-primary"),$("#pdfviewer-pages .pdfviewer-left").animate({scrollTop:$(".pdfviewer-thumb").eq(a-1).position().top+$("#pdfviewer-pages .pdfviewer-left").scrollTop()-$(".pdfviewer-thumb").eq(a-1).height()/2},100),$("#pdfviewer-pages").find(".pdfviewer-text").length>0&&b.getBoxes(a),$("#pdfviewer-pages").find(".pdfviewer-highlights").length>0&&b.getHighlights(),model.load({url:window.IL_BASE_URL+"index.php/pdf/logpage",data:{id:$("body").data("id"),page:a},async:!0})},400))}buttonPageNum(d){let a,b,c=600;switch($(this).data("value")){case"first":b=1;break;case"prev":for(a=b=parseInt($("#pdfviewer-page-input").val());a>b-10;a--){let e=$(".pdfviewer-page").eq(a-1)[0].getBoundingClientRect(),f=$(".pdfviewer-page").eq(a-2)[0].getBoundingClientRect();if(e.top>f.top){b=a-1;break}}c=200;break;case"next":for(a=b=parseInt($("#pdfviewer-page-input").val());a<b+10;a++){let g=$(".pdfviewer-page").eq(a-1)[0].getBoundingClientRect(),h=$(".pdfviewer-page").eq(a)[0].getBoundingClientRect();if(h.top>g.top){b=a+1;break}}c=200;break;case"last":b=$(".pdfviewer-page").last().data("page")}d.data.object.scrollToPage(b,c)}inputPageNum(b){let a=b.data.object,c=$(this).val();void 0!==a.t&&clearTimeout(a.t),a.t=_.delay(function(){a.scrollToPage(c)},300)}thumbPageNum(a){a.data.object.scrollToPage($(this).data("page"))}scrollToPage(a,b){1===$('.pdfviewer-page[data-page="'+a+'"]').length&&$(".pdfviewer-right").animate({scrollTop:$('.pdfviewer-page[data-page="'+a+'"]').position().top+$(".pdfviewer-right").scrollTop()-12},void 0===b?400:b)}scrollToElement(e,f){let g=void 0===f?400:f,a=$(".pdfviewer-right"),b=e.offset().top;(b<100||b>$(window).height()-100)&&a.animate({scrollTop:b+a.scrollTop()-$(window).height()/2},{duration:g,queue:!1});let c=e[0].getBoundingClientRect(),d=a[0].getBoundingClientRect();(c.left<d.left||c.right>d.right)&&a.animate({scrollLeft:a.scrollLeft()+c.left-d.left-.5*a.width()},{duration:g,queue:!1})}toggleCropper(a){if(void 0===a.data.object.cropper){a.data.object.clearHighlights(a),a.data.object.clearNotes(a),a.data.object.pageZoom("auto"),a.data.object.destroyTextLayer(),$(".dropdown.show .dropdown-toggle").dropdown("toggle"),$("#pdfviewer-menu").find("button, input, select").prop("disabled",!0),$(".btn-group-toggle").addClass("disabled").children().addClass("disabled"),$("#pdfviewer-image").prop("disabled",!1);let b=a.data.object.page-1;a.data.object.cropper=new Cropper($(".pdfviewer-page > img")[b],{background:!1,viewMode:1,dragMode:"move",initialAspectRatio:1,rotatable:!1,movable:!1,zoomable:!1,autoCropArea:.5,ready:function(){let a=$("#copy-image-btn-temp").clone(),b=$("#save-image-btn-temp").clone();$(".cropper-crop-box").append('<div id="crop-buttons" style="position: absolute;bottom:-3rem;white-space: nowrap"></div>'),a.attr("id","copy-image-btn").removeClass("d-none").appendTo("#crop-buttons"),b.attr("id","save-image-btn").removeClass("d-none").appendTo("#crop-buttons")}}),$("#pdfviewer-pages > .pdfviewer-right > .pdfviewer-page:first").hasClass("img-night-mode")&&a.data.object.nightMode()}else a.data.object.destroyCropper()}destroyCropper(){$("#pdfviewer-menu").find("button, input, select").prop("disabled",!1),$(".btn-group-toggle").removeClass("disabled").children().removeClass("disabled"),"object"==typeof this.cropper&&(this.cropper.destroy(),this.cropper=void 0)}getCroppedImage(c){let a=c.data.object,b=a.cropper.getData(!0),d=new URL(a.cropper.url);_.assign(b,{id:$("body").data("id"),page:a.page,zoom:d.searchParams.get("zoom")}),location.assign(window.IL_BASE_URL+"index.php/page/loadcrop?"+$.param(b))}saveCroppedImage(c){let a=c.data.object,b=a.cropper.getData(!0),d=new URL(a.cropper.url);_.assign(b,{id:$("body").data("id"),page:a.page,zoom:d.searchParams.get("zoom")}),model.save({url:window.IL_BASE_URL+"index.php/page/savecrop",data:$.param(b)})}toggleLeft(a){let b="object"==typeof a?a.data.object:this;$(".pdfviewer-left").hasClass("d-none")?b.showLeft():b.hideLeft()}showLeft(){$(".pdfviewer-left").removeClass("d-none"),$(window).trigger("resize.PdfMainView"),store.save("il.leftPanel",$(".pdfviewer-left").is(":visible")),!0===$("#pdfviewer-thumbs").hasClass("d-none")&& !0===$("#pdfviewer-bookmarks").hasClass("d-none")&& !0===$("#pdfviewer-notes").hasClass("d-none")&& !0===$("#pdfviewer-results").hasClass("d-none")&&this.showThumbs()}hideLeft(){$(".pdfviewer-left").addClass("d-none"),$(window).trigger("resize.PdfMainView"),store.save("il.leftPanel",$(".pdfviewer-left").is(":visible"))}showThumbs(a){let b="object"==typeof a?a.data.object:this;$("#pdfviewer-thumbs").removeClass("d-none"),$("#pdfviewer-bookmarks").addClass("d-none"),$("#pdfviewer-notes").addClass("d-none"),$("#pdfviewer-results").addClass("d-none"),b.redrawNoteLine(),b.redrawSnippetLine(),$(".pdfviewer-thumb > img").each(function(){"200px"!==this.style.width&&(this.style.width="200px",this.style.height=200/this.getAttribute("width")*this.getAttribute("height")+"px")})}showBookmarks(a){let b="object"==typeof a?a.data.object:this;if(1===$("#pdfviewer-bookmarks :text").length)return $("#pdfviewer-thumbs").addClass("d-none"),$("#pdfviewer-bookmarks").removeClass("d-none"),$("#pdfviewer-notes").addClass("d-none"),$("#pdfviewer-results").addClass("d-none"),b.redrawNoteLine(),b.redrawSnippetLine(),!1;$.when(model.load({url:window.IL_BASE_URL+"index.php/pdf/bookmarks?id="+$("body").data("id")})).done(function(a){$("#pdfviewer-thumbs").addClass("d-none"),$("#pdfviewer-notes").addClass("d-none"),$("#pdfviewer-results").addClass("d-none"),$("#pdfviewer-bookmarks").removeClass("d-none").html(a.html),$("#pdfviewer-bookmarks :text").filterable({targets:"#pdfviewer-bookmarks a"}).val(""),b.redrawNoteLine(),b.redrawSnippetLine()})}clickBookmark(a){a.preventDefault(),a.data.object.scrollToPage($(this).data("page"))}nightMode(){$("#pdfviewer-pages > .pdfviewer-right > .pdfviewer-page").toggleClass("img-night-mode img-light-mode");let a=$("#pdfviewer-pages > .pdfviewer-right > .pdfviewer-page:first").hasClass("img-night-mode");a?imageFilter.nightMode():imageFilter.lightMode(),store.save("il.nightMode",a)}toggleTextLayer(b){let a=b.data.object,c=a.page;0===$("#pdfviewer-pages").find(".pdfviewer-text").length?(a.clearHighlights(b),a.clearNotes(b),void 0===a.selectable&&(a.selectable=new Selectable({lasso:{backgroundColor:"transparent"},lassoSelect:"sequential",appendTo:"#pdfviewer-pages",maxSelectable:1e3})),a.selectable.off("end"),a.selectable.on("end",a.copyText),a.getBoxes(c)):a.destroyTextLayer()}destroyTextLayer(){$("#pdfviewer-pages").find(".pdfviewer-text").remove(),"object"==typeof this.selectable&&(this.selectable.off("end",this.copyText),this.selectable.disable(),this.selectable.destroy(),this.selectable=void 0)}copyText(){let a="";if($(".pdfviewer-text").children(".ui-selected").each(function(){a=a+$(this).attr("data-text")+" "}),a=(a=a.replace(/(- )/g,"")).replace(/\s{2,}/g," "),""===(a=$.trim(a)))return!1;$('<textarea id="copy-text-container" style="position: fixed;left: -1000px">'+a+"</textarea>").appendTo("body"),$("#copy-text-container").select();try{document.execCommand("copy"),$("#copy-text-container").remove()}catch(b){return $.jGrowl("Copied to clipboard not supported by this browser."),!1}$.jGrowl('<div class="text-truncate">'+a+"</div>",{header:"Copied to clipboard",theme:"bg-primary"}),this.clear()}getHighlights(){$.when(model.load({url:window.IL_BASE_URL+"index.php/pdf/highlights",data:{id:$("body").data("id")},async:!0})).done(function(a){$("#pdfviewer-pages").find(".pdfviewer-highlights").remove();let b="";"underlined"===store.load("il.highlightStyle")&&(b="underlined"),_.forEach(a.highlights,function(a,c){let d=$("#pdfviewer-pages").find(".pdfviewer-page").eq(c-1);$(a).addClass(b).insertAfter(d.children("img"))})})}showAnnotations(a){let b=a.data.object;0===$("#pdfviewer-pages").find(".pdfviewer-highlights").length&&b.getHighlights(),b.showNotes(a)}hideAnnotations(a){let b=a.data.object;b.clearHighlights(a),b.clearNotes(a)}addHighlights(b){let a=b.data.object,c=a.page;a.clearNotes(b),$(this).hasClass("highlight-blue")?(store.save("il.highlight","B"),$("#pdfviewer-pages").find(".pdfviewer-page").removeClass(function(b,a){return(a.match(/(^|\s)cursor-\S+/g)||[]).join(" ")}).addClass("cursor-marker-blue")):$(this).hasClass("highlight-yellow")?(store.save("il.highlight","Y"),$("#pdfviewer-pages").find(".pdfviewer-page").removeClass(function(b,a){return(a.match(/(^|\s)cursor-\S+/g)||[]).join(" ")}).addClass("cursor-marker-yellow")):$(this).hasClass("highlight-green")?(store.save("il.highlight","G"),$("#pdfviewer-pages").find(".pdfviewer-page").removeClass(function(b,a){return(a.match(/(^|\s)cursor-\S+/g)||[]).join(" ")}).addClass("cursor-marker-green")):$(this).hasClass("highlight-red")&&(store.save("il.highlight","R"),$("#pdfviewer-pages").find(".pdfviewer-page").removeClass(function(b,a){return(a.match(/(^|\s)cursor-\S+/g)||[]).join(" ")}).addClass("cursor-marker-red")),0===$("#pdfviewer-pages").find(".pdfviewer-highlights").length&&a.getHighlights(),void 0===a.selectable&&(a.selectable=new Selectable({lasso:{backgroundColor:"transparent"},lassoSelect:"sequential",appendTo:"#pdfviewer-pages",maxSelectable:1e3})),a.selectable.off("end"),a.selectable.on("end",a.saveHighlights),0===$("#pdfviewer-pages").find(".pdfviewer-text").length&&a.getBoxes(c)}saveHighlights(e,d){let f=window.pdfmainview||views.pdfmain,b={},a,c=store.load("il.highlight");switch(c){case"R":a="red";break;case"G":a="green";break;case"B":a="blue";break;case"Y":a="yellow"}_.forEach(d,function(d,e){let f,g,h,i,c=$(d.node),j=c.parent().siblings(".pdfviewer-highlights"),k=c.attr("style").split(";");c.clone().removeClass("ui-selectable ui-selected").addClass(a).appendTo(j),_.forEach(k,function(b){let a=b.split(":");switch(a[0]){case"top":f=10*parseFloat(a[1].slice(0,-1));break;case"left":g=10*parseFloat(a[1].slice(0,-1));break;case"width":h=10*parseFloat(a[1].slice(0,-1));break;case"height":i=10*parseFloat(a[1].slice(0,-1))}}),b[e]={page:c.closest(".pdfviewer-page").data("page"),top:f,left:g,width:h,height:i,position:c.data("position"),text:c.attr("data-text")}}),"object"==typeof b[0]&&$.when(model.save({url:window.IL_BASE_URL+"index.php/pdf/savehighlights",data:{id:$("body").data("id"),color:c,boxes:JSON.stringify(b)},async:!0})).done(function(){f.getHighlights()})}clearHighlights(c){let a=c.data.object,b=$("#pdfviewer-pages");b.find(".pdfviewer-text").remove(),store.delete("il.highlight"),"object"==typeof a.selectable&&(a.selectable.off("end",a.saveHighlights),a.selectable.destroy(),a.selectable=void 0),b.find(".pdfviewer-page").removeClass(function(b,a){return(a.match(/(^|\s)cursor-\S+/g)||[]).join(" ")}),b.find(".pdfviewer-highlights").remove()}eraserInit(c){let a=c.data.object,b=$("#pdfviewer-pages");b.find(".pdfviewer-highlights").length>0&&(void 0===a.selectable&&(a.selectable=new Selectable({lasso:{backgroundColor:"transparent"},lassoSelect:"sequential",appendTo:"#pdfviewer-pages",maxSelectable:1e3})),a.selectable.off("end"),a.selectable.on("end",a.deleteHighlights),0===b.find(".pdfviewer-text").length&&a.getBoxes(a.page),b.find(".pdfviewer-page").addClass("cursor-eraser"))}deleteHighlights(c,b){let d=window.pdfmainview||views.pdfmain,a={};_.forEach(b,function(d,e){let b=$(d.node),f=b.parent().siblings(".pdfviewer-highlights"),c=b.data("position");f.children('[data-position="'+c+'"]').remove(),a[e]={page:b.closest(".pdfviewer-page").data("page"),position:c}}),"object"==typeof a[0]&&$.when(model.save({url:window.IL_BASE_URL+"index.php/pdf/deletehighlights",data:{id:$("body").data("id"),boxes:JSON.stringify(a)},async:!0})).done(function(){d.getHighlights()})}highlightStyle(){!0===$(this).prop("checked")?($("#pdfviewer-pages").find(".pdfviewer-highlights").addClass("underlined"),store.save("il.highlightStyle","underlined")):($("#pdfviewer-pages").find(".pdfviewer-highlights").removeClass("underlined"),store.save("il.highlightStyle","highlight"))}getLinks(){let a=new EventSource(IL_BASE_URL+"index.php/pdf/links?id="+$("body").data("id"));a.onmessage=function(b){if("CLOSE"===b.data||0===$("#pdfviewer-pages").length)a.close();else{let c=JSON.parse(b.data);_.forEach(c,function(a,b){$("#pdfviewer-pages").find(".pdfviewer-page").eq(b-1).append(a)})}}}getBoxes(a){let b=this;$.when(model.load({url:window.IL_BASE_URL+"index.php/pdf/boxes",data:{id:$("body").data("id"),page:a},async:!0})).done(function(a){$("#pdfviewer-pages").find(".pdfviewer-text").remove(),_.forEach(a.boxes,function(c,d){let a=$("#pdfviewer-pages").find(".pdfviewer-page").eq(d-1);a.append(c),b.selectable.add(a.children(".pdfviewer-text").children().get())})})}search(b){if(13!==b.which)return!1;let a=b.data.object,e=$(this),i=$(".pdfviewer-right > div:last-child").data("page"),f=$("#pdfviewer-results > .pdfviewer-no-results-container"),g=$("#pdfviewer-results > .pdfviewer-results-container"),c=$("#pdfviewer-search-progress"),h=$("#pdfviewer-pages"),d;f.removeClass("d-none"),g.empty(),h.find(".pdfviewer-result-boxes").remove(),"object"==typeof a.sseSearch&&2!==a.sseSearch.readyState&&(a.sseSearch.close(),clearTimeout(d),c.addClass("d-none"),c.find("div").width("0%").attr("aria-value-now","0%")),d=setTimeout(function(){c.removeClass("d-none")},500),a.sseSearch=new EventSource(IL_BASE_URL+"index.php/pdf/search?id="+$("body").data("id")+"&query="+e.val()),a.sseSearch.onmessage=function(e){if("CLOSE"===e.data||0===h.length)a.sseSearch.close(),clearTimeout(d),c.addClass("d-none"),c.find("div").width("0%").attr("aria-value-now","0%");else{let b=JSON.parse(e.data);_.forEach(b.boxes,function(a,b){h.find(".pdfviewer-page").eq(b-1).children("img").after(a)}),_.forEach(b.snippets,function(a){$(a).appendTo("#pdfviewer-results > .pdfviewer-results-container"),!1===f.hasClass("d-none")&&f.addClass("d-none")});let j=Math.floor(Math.min(100,100*b.last_page/i));c.find("div").width(j+"%").attr("aria-value-now",j+"%"),0===g.find("a.bg-dark").length&&g.find("a").eq(0).trigger("click").focus()}},a.showResults(),!1===$(".navbar-toggler").is(":visible")&&a.showLeft()}showResults(a){let b="object"==typeof a?a.data.object:this;$("#pdfviewer-thumbs").addClass("d-none"),$("#pdfviewer-bookmarks").addClass("d-none"),$("#pdfviewer-notes").addClass("d-none"),$("#pdfviewer-results").removeClass("d-none"),b.redrawNoteLine(),b.redrawSnippetLine()}scrollToResult(c){let a=c.data.object;$("#pdfviewer-results .snippet").removeClass("bg-dark"),$(this).addClass("bg-dark");let b=$("#"+$(this).data("box"));a.drawSnippetLine($(this).data("box")),a.scrollToElement(b),$(".pdfviewer-result-boxes > div").removeClass("active"),b.addClass("active")}nextResult(){let a=$("#pdfviewer-results a.bg-dark").next();1===a.length?a.trigger("click"):$("#pdfviewer-results a").eq(0).trigger("click")}prevResult(){let a=$("#pdfviewer-results a.bg-dark").prev();1===a.length?a.trigger("click"):$("#pdfviewer-results a").last().trigger("click")}showNotes(a){let b=a.data.object;$("#pdfviewer-thumbs").addClass("d-none"),$("#pdfviewer-bookmarks").addClass("d-none"),$("#pdfviewer-notes").removeClass("d-none"),$("#pdfviewer-results").addClass("d-none"),b.redrawSnippetLine(),$.when(model.load({url:window.IL_BASE_URL+"index.php/pdf/notelist",data:{id:$("body").data("id")}})).done(function(a){$("#pdfviewer-notes").html(a.list),_.forEach(a.pages,function(b,c){let a=$("#pdfviewer-pages").find(".pdfviewer-page").eq(c-1);a.find(".pdfviewer-notes").remove(),a.append(b)}),$(".pdfnote").tooltip({animation:!1,template:'<div class="tooltip" role="tooltip"><div class="tooltip-inner bg-secondary rounded-0 text-left px-3 py-2 border border-light"></div></div>'}).on("shown.bs.tooltip",function(){"function"==typeof window.MathJax.typeset&&window.MathJax.typeset(),$(this).tooltip("update")}),$("#pdfviewer-notes").on("click",".note-btn",function(){let a=$(this).data("id");b.scrollToElement($("#pdfnote-"+a)),$(".note-btn").removeClass("active"),$(this).addClass("active"),$(".pdfnote").tooltip("hide"),b.drawNoteLine(a)}),$(".pdfnote").on("click",function(){let a=$(this).data("id");$("#pdfviewer-notes .note-btn").removeClass("active"),$("#pdfviewer-notes").find('.note-btn[data-id="'+a+'"]').addClass("active"),b.drawNoteLine(a)}),"function"==typeof window.MathJax.typeset&&window.MathJax.typeset()})}editNote(b){let a=$(this).parent();a.addClass("d-none"),a.next().removeClass("d-none")}saveNote(b){let d=b.data.object,a=$(this),e=a.find("textarea").val(),f=a.parent().data("id")||0,c=$("body").data("id");b.preventDefault(),$.when(model.save({url:a.attr("action"),data:a.serialize()+"&id="+c,async:!0})).done(function(){a.addClass("d-none"),""===$.trim(e)||0===f?d.showNotes(b):(a.prev().removeClass("d-none").find("button").eq(0).text(e),$("#pdfnote-"+f).attr("data-title",e).attr("data-original-title",e),"function"==typeof window.MathJax.typeset&&window.MathJax.typeset())})}createNewNote(b){let a=b.data.object;!0===$(".pdfviewer-page").hasClass("cursor-cross")?a.clearNewNote():(a.clearHighlights(b),a.showNotes(b),a.showLeft(),$(".pdfviewer-page").addClass("cursor-cross"),$(".pdfviewer-page").on("click.createnote",".pdfviewer-notes",function(c){let d=Math.round(1e3*(c.pageX-$(this).offset().left)/$(this).width()),e=Math.round(1e3*(c.pageY-$(this).offset().top)/$(this).height()),f=$(this).closest(".pdfviewer-page").data("page"),b=$("#new-note-form");b.removeClass("d-none").find('[name="pg"]').val(f),b.find('[name="left"]').val(d),b.find('[name="top"]').val(e),$(".pdfnote.new").remove(),$('<div class="pdfnote new" style="left:'+d/10+"%;top:"+e/10+'%;"></div>').appendTo(this),a.clearNewNote()}))}clearNotes(a){a.data.object.clearNewNote(),$("#pdfviewer-notes").empty(),$("#pdfviewer-pages").find(".pdfviewer-notes").remove()}clearNewNote(){$(".pdfviewer-page").removeClass("cursor-cross"),$(".pdfviewer-page").off("click.createnote")}drawNoteLine(c){let g=$("#pdfnote-"+c),h=$("#pdfviewer-notes").find('.note-group[data-id="'+c+'"]'),d=g[0].getBoundingClientRect(),b=h[0].getBoundingClientRect(),k=b.right,e=Math.min(b.top+15,d.top),f=d.left-b.right,a=d.top-(b.top+15),i="";(null===h[0].offsetParent||e<50||a+e>$(window).height()||f<1)&&(i="d-none");let j="";a<0&&(j='transform="scale (-1, 1)" transform-origin="center"',a=Math.abs(a)),0===a&&(a=1);let l=`
            <svg
                id="note-line" data-note-id="${c}" class="${i}"
                style="pointer-events: none;position: fixed;width: ${f}px;height: ${a}px;top: ${e}px;left: ${k}px"
                viewBox="0 0 ${f} ${a}"
                xmlns="http://www.w3.org/2000/svg">
                <line x1="0" y1="0" x2="100%" y2="100%"
                    stroke="rgba(47, 141, 237, 0.75)" stroke-dasharray="0, 6" stroke-width="2" stroke-linecap="round"
                    ${j} />
            </svg>`;$("#note-line").remove(),g.parent().prepend(l)}redrawNoteLine(){let a=$("#note-line");1===a.length&&this.drawNoteLine(a.attr("data-note-id"))}drawSnippetLine(c){let g=$("#"+c),h=$(".pdfviewer-results-container").find('[data-box="'+c+'"]'),d=g[0].getBoundingClientRect(),b=h[0].getBoundingClientRect(),k=b.right,e=Math.min(b.top+20,d.top),f=d.left-b.right,a=d.top-(b.top+20),i="";(null===h[0].offsetParent||e<50||a+e>$(window).height()||f<1)&&(i="d-none");let j="";a<0&&(j='transform="scale (-1, 1)" transform-origin="center"',a=Math.abs(a)),0===a&&(a=1);let l=`
            <svg
                id="snippet-line" data-snippet-id="${c}" class="${i}"
                style="pointer-events: none;position: fixed;width: ${f}px;height: ${a}px;top: ${e}px;left: ${k}px"
                viewBox="0 0 ${f} ${a}"
                xmlns="http://www.w3.org/2000/svg">
                <line x1="0" y1="0" x2="100%" y2="100%"
                    stroke="rgba(255, 0, 255, 0.75)" stroke-dasharray="0, 6" stroke-width="2" stroke-linecap="round"
                    ${j} />
            </svg>`;$("#snippet-line").remove(),g.parent().prepend(l)}redrawSnippetLine(){let a=$("#snippet-line");1===a.length&&this.drawSnippetLine(a.attr("data-snippet-id"))}openLink(b){let c=b.data.object,a=$(this).data("href");"number"==typeof a?c.scrollToPage(a):window.open(a)}}views.pdfmain=new PdfMainView;class PdfManageView extends View{constructor(){super(),this.parent="#content-col"}afterRender(a){$("#upload-form").uploadable(),$("#delete-pdf").confirmable({submit:function(){let a=$("body").data("id");$.when(model.save({url:window.IL_BASE_URL+"index.php/pdf/delete",data:{id:a}})).done(function(){B.history.loadUrl()})}}),$("#reindex-pdf").confirmable({submit:function(){let a=$("body").data("id");$.when(model.save({url:window.IL_BASE_URL+"index.php/pdf/extract",data:{id:a}})).done(function(){B.history.loadUrl()})}}),$("#ocr-pdf").confirmable({submit:function(){let a=$("#ocr-form");$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){B.history.loadUrl()})}}),$("body").off("submit.pdfmanage").on("submit.pdfmanage","#ocr-form",function(a){a.preventDefault()}),"object"==typeof itemview&&(itemview.clickTitle(),itemview.changeTitleLink())}}views.pdfmanage=new PdfManageView;class ImportWizardView extends View{constructor(){super(),this.parent="#content-col"}}views.importwizard=new ImportWizardView;class ImportUidView extends View{constructor(){super(),this.parent="#content-col",this.inputType="",this.events={"click #fetch-record":"fetch","input #uid":"uidResolve","keydown #uid":"preventSubmit"}}afterRender(a){formStyle.init(),$("#upload-form").uploadable(),$("#tag-filter").filterable({complete:function(){$("#content-col .label-text").each(function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")}),$(".tag-table").find("tr").each(function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")})}})}uidResolve(c){let a=$.trim($(this).val());if(!0===/^10\.\d{4}/.test(a))$("#new-uid-type").val("DOI");else if(!0===/^http/i.test(a)){let b=new URL(a).pathname.substr(1);!0===/^10\.\d{4}/.test(b)&&($(this).val(b),$("#new-uid-type").val("DOI"))}else!0===/^pmid:/i.test(a)?$("#new-uid-type").val("PMID"):!0===/^ieee:/i.test(a)?$("#new-uid-type").val("IEEE"):!0===/^arxiv:/i.test(a)?$("#new-uid-type").val("ARXIV"):!0===/^[0-9]{4}.{14}[A-Z]/.test(a)?$("#new-uid-type").val("NASAADS"):!0===/^pmc.*|pmcid:/i.test(a)?$("#new-uid-type").val("PMCID"):!0===/^OL/.test(a)?$("#new-uid-type").val("OL"):!0===/^[A-Z]{2}\d+/.test(a)?$("#new-uid-type").val("PAT"):!0===/^[SP]\d/.test(a)?$("#new-uid-type").val("DIRECT"):!0===/^ISBN:\s?\d/.test(a)?$("#new-uid-type").val("ISBN"):$("#new-uid-type").val("");$("#select-type").collapse("show")}fetch(i){let a=$.trim($("#uid").val());switch($("#new-uid-type").val()){case"DOI":$.when(model.load({url:window.IL_BASE_URL+"index.php/crossref/fetch",data:{uid:a}})).done(function(b){let a=b.items[0]||[];void 0===a.title?$("#uid-message").removeClass("d-none").html("No record found. Try another UID."):($(".import-wizard-uid").html('Record found:<h5><a href="'+a.urls[0]+'" target="_blank">'+a.title+"</a></h5>"),$(".uploadable-url").val(a.urls[1]||""),$("#metadata").val(JSON.stringify(a)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit").removeClass("d-none"),$("#phase-2").removeClass("d-none"))}).fail(function(a){404===a.status&&$("#uid-message").removeClass("d-none").html("No record found. Try another UID.")});break;case"PMID":let b=a.replace(/\D/g,"");$.when(model.load({url:"https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&retmode=xml&id="+b,cors:!0,dataType:"text"})).done(function(a){$.when(model.save({url:window.IL_BASE_URL+"index.php/pubmed/format",data:{xml:a}})).done(function(b){let a=b.items[0]||[];void 0===a.title?$("#uid-message").removeClass("d-none").html("No record found. Try another UID."):($(".import-wizard-uid").html('Record found:<h5><a href="'+a.urls[0]+'" target="_blank">'+a.title+"</a></h5>"),$(".uploadable-url").val(a.urls[1]||""),$("#metadata").val(JSON.stringify(a)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit").removeClass("d-none"),$("#phase-2").removeClass("d-none"))})});break;case"PMCID":let c=$.trim(a.replace(/pmcid:/gi,""));$.when(model.load({url:"https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pmc&retmode=xml&id="+c,cors:!0,dataType:"text"})).done(function(a){$.when(model.save({url:window.IL_BASE_URL+"index.php/pmc/format",data:{xml:a}})).done(function(b){let a=b.items[0]||[];void 0===a.title?$("#uid-message").removeClass("d-none").html("No record found. Try another UID."):($(".import-wizard-uid").html('Record found:<h5><a href="'+a.urls[0]+'" target="_blank">'+a.title+"</a></h5>"),$(".uploadable-url").val(a.urls[1]||""),$("#metadata").val(JSON.stringify(a)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit").removeClass("d-none"),$("#phase-2").removeClass("d-none"))})});break;case"ISBN":let d=$.trim(a.replace(/isbn:/gi,""));$.when(model.load({url:"https://openlibrary.org/api/books?bibkeys=ISBN:"+d+"&jscmd=data&format=json",cors:!0,dataType:"text"})).done(function(a){$.when(model.save({url:window.IL_BASE_URL+"index.php/ol/convert",data:{json:a}})).done(function(b){let a=b.items[0]||[];void 0===a.title?$("#uid-message").removeClass("d-none").html("No record found. Try another UID."):($(".import-wizard-uid").html('Record found:<h5><a href="'+a.urls[0]+'" target="_blank">'+a.title+"</a></h5>"),$("#metadata").val(JSON.stringify(a)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit").removeClass("d-none"),$("#phase-2").removeClass("d-none"))})});break;case"OL":let e=$.trim(a.replace(/isbn:/gi,""));$.when(model.load({url:"https://openlibrary.org/api/books?bibkeys=OLID:"+e+"&jscmd=data&format=json",cors:!0,dataType:"text"})).done(function(a){$.when(model.save({url:window.IL_BASE_URL+"index.php/ol/convert",data:{json:a}})).done(function(b){let a=b.items[0]||[];void 0===a.title?$("#uid-message").removeClass("d-none").html("No record found. Try another UID."):($(".import-wizard-uid").html('Record found:<h5><a href="'+a.urls[0]+'" target="_blank">'+a.title+"</a></h5>"),$("#metadata").val(JSON.stringify(a)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit").removeClass("d-none"),$("#phase-2").removeClass("d-none"))})});break;case"IEEE":let f=a.replace(/ieee:\s?/i,"");$.when(model.load({url:window.IL_BASE_URL+"index.php/ieee/fetch",data:{uid:f}})).done(function(b){let a=b.items[0];$(".import-wizard-uid").html('Record found:<h5><a href="https://ieeexplore.ieee.org/document/"'+f+' target="_blank">'+a.title+"</a></h5>"),$("#metadata").val(JSON.stringify(a)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit").removeClass("d-none"),$("#phase-2").removeClass("d-none")});break;case"ARXIV":let g=a.replace(/arxiv:\s?/i,"");$.when(model.load({url:arxiv.url+g,cors:!0,dataType:"xml"})).done(function(a){let b=$(a).find("entry"),c=b.children("title").text();$(".import-wizard-uid").html('Record found:<h5><a href="'+b.children("id").text()+'" target="_blank">'+c+"</a></h5>"),$("#metadata").val(arxiv.metadata($(a))),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit").removeClass("d-none"),$("#phase-2").removeClass("d-none")}).fail(function(a){400===a.status&&$("#uid-message").removeClass("d-none").html("No record found. Try another UID.")});break;case"NASAADS":$.when(model.load({url:window.IL_BASE_URL+"index.php/nasa/fetch",data:{uid:a}})).done(function(b){let a=b.items[0]||[];void 0===a.title?$("#uid-message").removeClass("d-none").html("No record found. Try another UID."):($(".import-wizard-uid").html('Record found:<h5><a href="'+a.urls[0]+'" target="_blank">'+a.title+"</a></h5>"),$(".uploadable-url").val(a.urls[1]||""),$("#metadata").val(JSON.stringify(a)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit").removeClass("d-none"),$("#phase-2").removeClass("d-none"))});break;case"PAT":let h=a.replace(/patent:\s?/i,"");$.when(model.load({url:window.IL_BASE_URL+"index.php/patents/fetch",data:{uid:h}})).done(function(b){let a=b.items[0]||[];void 0===a.title?$("#uid-message").removeClass("d-none").html("No record found. Try another UID."):($(".import-wizard-uid").html('Record found:<h5><a href="'+a.urls[0]+'" target="_blank">'+a.title+"</a></h5>"),$(".uploadable-url").val(a.urls[1]||""),$("#metadata").val(JSON.stringify(a)),$("#fetch-record").addClass("d-none"),$("#upload-form").find(":submit").removeClass("d-none"),$("#phase-2").removeClass("d-none"))})}}preventSubmit(a){13===a.which&&(a.preventDefault(),a.data.object.fetch())}}views.importuid=new ImportUidView;class ImportFileView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #upload-form":"saveRepository"}}afterRender(a){formStyle.init(),$("#upload-form").uploadable(),$("#tag-filter").filterable({complete:function(){$("#content-col .label-text").each(function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")}),$(".tag-table").find("tr").each(function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")})}}),$("#upload-form").find('input[name="repository"]').val([store.load("il.repository")]),formStyle.updateForm($("#upload-form"))}saveRepository(){store.save("il.repository",$("#upload-form").find('input[name="repository"]:checked').val())}}views.importfile=new ImportFileView;class ImportTextView extends View{constructor(){super(),this.parent="#content-col"}afterRender(a){formStyle.init(),$("#upload-form").uploadable(),$("#tag-filter").filterable({complete:function(){$("#content-col .label-text").each(function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")}),$(".tag-table").find("tr").each(function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")})}})}}views.importtext=new ImportTextView;class ImportManualView extends View{constructor(a){super(),this.parent="#content-col",this.editmain=a}afterRender(a){formStyle.init(),$("#upload-form").uploadable({pdftitles:function(b,a){$("#extracted-titles").empty(),a.titles.length>0&&$("#title").val(a.titles.pop())},change:function(b,a){$("#title").val(a.name.substr(0,a.name.lastIndexOf(".")))},clear:function(a){$("#title").val("")}}),this.editmain.uploadFormWidgets(),$("#tag-filter").filterable({complete:function(){$("#content-col .label-text").each(function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")}),$(".tag-table").find("tr").each(function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")})}})}}views.importmanual=new ImportManualView(views.editmain);class ExternalMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit .search-form":"search","click .delete-search":"deleteSearch","click .edit-search":"loadForm"}}afterRender(a){formStyle.init(),$(".clone-button").clonable({target:"#search-row"}),$(this.parent).find("form").saveable()}search(a){a.preventDefault(),$(this).saveable("save");let b=$(this).serialize();router.navigate($(this).attr("action")+"?"+b,{trigger:!0})}deleteSearch(b){let a=$(this);$.when(model.save({url:a.data("url"),data:{id:a.data("id")}})).done(function(){B.history.loadUrl()})}loadForm(){let d=$(this).closest(".list-group-item").find("a").attr("href"),e=new URL("http://foo.bar/"+d.substr(1)).searchParams.entries(),a=[];for(let f of e){let[g,b]=f;""!==b&&a.push({name:g,value:b})}let c=$("#content-col").find("form");c.saveable("saveParams",a),c.saveable("load")}}views.ieeemain=new ExternalMainView,views.arxivmain=new ExternalMainView,views.crossrefmain=new ExternalMainView,views.pubmedmain=new ExternalMainView,views.pmcmain=new ExternalMainView,views.nasamain=new ExternalMainView,views.patentsmain=new ExternalMainView,views.sciencedirectmain=new ExternalMainView,views.scopusmain=new ExternalMainView;class ExternalSearchView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .add-pdf-btn":"makeUploadable","click button":"makeUploadable"}}afterRender(a){formStyle.init(),$(window).off("resize.ExternalSearchView").on("resize.ExternalSearchView",function(){views.itemsmain.itemsHeight()}),views.itemsmain.itemsHeight(),$("#content-col .tag-filter").filterable({complete:function(){let a=$(this).closest(".collapse"),b=$(this).closest(".collapse").find("table");a.find(".label-text").each(function(){$(this).hasClass("d-none")?$(this).parent().parent().addClass("d-none"):$(this).parent().parent().removeClass("d-none")}),b.find("tr").each(function(){$(this).find(".label-text").length-$(this).find(".label-text.d-none").length==0?$(this).addClass("d-none"):$(this).removeClass("d-none")})}})}makeUploadable(){$(this).closest("form").uploadable()}}views.ieeesearch=new ExternalSearchView,views.arxivsearch=new ExternalSearchView,views.crossrefsearch=new ExternalSearchView,views.pubmedsearch=new ExternalSearchView,views.pmcsearch=new ExternalSearchView,views.nasasearch=new ExternalSearchView;class GlobalSettingsMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #settings-form":"submitForm"}}afterRender(a){formStyle.init()}submitForm(c){c.preventDefault();let a=$(this),b=$.trim($("#wpad-url").val());!0===$("#connection-url").prop("checked")&&""!==b?$.getScript(b,function(){let b=FindProxyForURL("","www.crossref.org"),d="",c=b.split(";");_.forEach(c,function(a){if(0===_.trim(a).indexOf("PROXY"))return d=a.substr(6),$("#proxy-pac").val(d),!1}),$.when(model.save({url:a.attr("action"),data:a.serialize()}))}).fail(function(){$.jGrowl("Unable to fetch the PAC/WPAD file.",{header:"Error",theme:"bg-danger"})}):$.when(model.save({url:a.attr("action"),data:a.serialize()}))}}views.globalsettingsmain=new GlobalSettingsMainView;class UsersMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"click .update-user":"updateUser","click #create-user":"createUser"}}afterRender(a){$(".reset-password").confirmable({submit:this.resetPassword})}updateUser(){let a=$(this).closest("tr"),b=a.find(".email").val();if(""===$.trim(b)){$.jGrowl("Email is required.",{header:"Info",theme:"bg-primary"});return}$.when(model.save({url:window.IL_BASE_URL+"index.php/users/update",data:{user:{username:a.find(".username").text(),first_name:a.find(".first-name").val(),last_name:a.find(".last-name").val(),email:b,permissions:a.find(".permissions").val(),status:a.find(".status").val()}}})).done(function(){B.history.loadUrl()})}createUser(){let a=$(this).closest("tr"),b=a.find(".email").val();if(""===$.trim(b)){$.jGrowl("Email is required.",{header:"Info",theme:"bg-primary"});return}$.when(model.save({url:window.IL_BASE_URL+"index.php/users/create",data:{user:{username:a.find(".username").val(),first_name:a.find(".first-name").val(),last_name:a.find(".last-name").val(),email:b,permissions:a.find(".permissions").val()}}})).done(function(a){"string"==typeof a.password&&$.jGrowl(a.password,{sticky:!0,theme:"bg-dark text-light"}),B.history.loadUrl()})}resetPassword(){let a=$(this).closest("tr"),b=a.find(".email").val();if(""===$.trim(b)){$.jGrowl("User's email is required to reset password.",{header:"Info",theme:"bg-primary"});return}$.when(model.save({url:window.IL_BASE_URL+"index.php/users/reset",data:{user:{username:a.find(".username").text(),email:b}}})).done(function(a){"string"==typeof a.password&&$.jGrowl(a.password,{sticky:!0,theme:"bg-dark"})})}}views.usersmain=new UsersMainView;class DetailsMainView extends View{constructor(){super(),this.parent="#content-col"}}views.detailsmain=new DetailsMainView;class LogsMainView extends View{constructor(){super(),this.parent="#content-col"}}views.logsmain=new LogsMainView;class CitationMainView extends View{constructor(){super(),this.parent="#content-col",this.events={"submit #form-new-csl":"submitForm"}}afterRender(a){window.tables["table-csl"]=$("#table-csl").DataTable({deferRender:!0,data:a.styles,columnDefs:[{orderable:!1,targets:2}]}),$("#modal-csl").off("shown.bs.modal").on("shown.bs.modal",function(a){$("#modal-csl").find(".modal-title").text($(a.relatedTarget).attr("data-name")),$.when(model.load({url:window.IL_BASE_URL+"index.php/citation/get",data:{id:$(a.relatedTarget).attr("data-id")}})).done(function(a){$("#modal-csl").find("code").html(a.csl)})})}submitForm(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){a[0].reset()})}}views.citationmain=new CitationMainView;class MainView{constructor(){sidebar.init(),(""===location.hash||"#"===location.hash)&&1===$("#side-menu").length&&router.navigate("dashboard/main",{trigger:!0,replace:!0}),$("#signin-form").on("submit",function(b){b.preventDefault();let a=$(this),c=new URL(window.location.href).searchParams.get("ref");""!==$.trim(a.find('[name="username"]').val())&&""!==$.trim(a.find('[name="password"]').val())&&$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(b){if(void 0===b.info){if("string"==typeof c){let a=window.atob(c);new URL(a).hostname===location.hostname?location.replace(a):location.replace(IL_BASE_URL+"index.php/#dashboard/main")}else location.replace(IL_BASE_URL+"index.php/#dashboard/main")}})}),$("#migrate-form").on("submit",function(b){b.preventDefault();let a=$(this);$.when(model.load({url:a.attr("action")+"?"+a.serialize()})).done(function(a){void 0===a.info&&location.replace(window.IL_BASE_URL)})}),$("#sign-out").on("click",function(){$.when(model.save({url:window.IL_BASE_URL+"index.php/authentication/signout"})).done(function(){location.assign(window.IL_BASE_URL)})}),$(".modal-content").draggable({containment:"document",handle:".modal-header"}),$("#keyboard-toggle").on("click",function(){keyboard.init()}),$("#content-col").on("click","#open-settings",function(){""===$.trim($("#modal-settings").find(".modal-body").html())&&$.when(model.load({url:window.IL_BASE_URL+"index.php/settings/display"})).done(function(a){$("#modal-settings").find(".modal-body").html(a.html),formStyle.init()})}),$("#modal-settings .modal-footer button").eq(0).on("click",function(a){$("#modal-settings form").trigger("submit")}),$("#modal-settings").on("submit","form",function(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){B.history.loadUrl()}),$("#modal-settings").modal("hide")}),searchlist.init()}}class MigrationView{constructor(){$("#migrate-form").on("submit",function(b){b.preventDefault();let a=$(this);$.when(model.load({url:a.attr("action")+"?"+a.serialize()})).done(function(a){void 0===a.info&&location.replace(window.IL_BASE_URL)})})}}class RegistrationView{constructor(){$("#signup-form").on("submit",function(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(a){void 0===a.info&&location.assign(window.IL_BASE_URL)})})}}class ResetpasswordView{constructor(){$("form").on("submit",function(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(a){$(".container-fluid").html(a.html)})}),$("body").on("click","#new-password",function(){let a=window.getSelection(),b=document.createRange();b.selectNodeContents($("#new-password")[0]),a.removeAllRanges(),a.addRange(b)})}}class ItemView{constructor(){sidebar.init();let d="string"==typeof store.load("il.itemReferrer")?store.load("il.itemReferrer"):window.IL_BASE_URL+"#items/main";$("#item-back-link").attr("href",d);let a=new URL("http://foo.bar/"+location.hash.substring(1)).searchParams.get("id")||"";$("body").attr("data-id",a).data("id",a),$("#id-hidden").val(a),$("a.add-id-link").each(function(){let b=$(this).attr("href").split("id=");$(this).attr("href",b[0]+"id="+a)}),$("#keyboard-toggle").on("click",function(){keyboard.init()}),$("#sign-out").on("click",function(){$.when(model.save({url:window.IL_BASE_URL+"index.php/authentication/signout"})).done(function(){location.assign(window.IL_BASE_URL)})});let b=sessionStore.load("il.idList");if(null===b||b.length<2)$("#left-item-list").addClass("d-none");else{let c=$("#left-item-list .left-item-link").detach(),e=c.attr("href");b.forEach(function(b){let d=b.id===a?"bg-darker-10":"";c.clone().addClass(d).attr("href",e.replace("{ID}",b.id)).attr("data-id",b.id).html(b.title).appendTo("#left-item-list")}),c=void 0,$("#left-item-list").removeClass("d-none").hide().fadeIn()}}clickTitle(){let a=$("#left-item-list"),c=$("#left-item-list .left-item-link.bg-darker-10");if(0===c.length){a.addClass("d-none"),sessionStore.delete("il.idList");return}if(a.hasClass("d-none"))return;let b=new URL("http://foo.bar/"+location.hash.substring(1)).searchParams.get("id")||"";$("#left-item-list .left-item-link").each(function(){$(this).removeClass("bg-darker-10"),$(this).attr("data-id")===b&&$(this).addClass("bg-darker-10")});let e=c.position().top,f=a.scrollTop(),d=c[0].getBoundingClientRect(),g=a[0].getBoundingClientRect();(d.top<10||g.bottom-d.bottom<10)&&a.animate({scrollTop:f+e-$(window).height()/3},250),$("a.add-id-link").each(function(){let a=$(this).attr("href").split("id=");$(this).attr("href",a[0]+"id="+b)}),$("body").attr("data-id",b).data("id",b),1===$("#id-hidden").length&&$("#id-hidden").val()!==b&&$.when(model.load({url:window.IL_BASE_URL+"index.php/notes/user",data:{id:b}})).done(function(a){$("#notes-ta").val(a.user.note),$("#id-hidden").val(b),null!==window.tinymce.activeEditor&& !0===window.tinymce.activeEditor.initialized&&window.tinymce.activeEditor.load()})}changeTitleLink(){if($("#left-item-list").hasClass("d-none"))return;let a="#"+new URL("http://foo.bar/"+location.hash.substring(1)).pathname.substring(1);$("#left-item-list .left-item-link").each(function(){$(this).attr("href",a+"?id="+$(this).attr("data-id"))})}}class ProjectView{constructor(){sidebar.init();let a=new URL("http://foo.bar/"+location.hash.substring(1)).searchParams.get("id")||"";$("body").attr("data-id",a).data("id",a),$("a.add-id-link").each(function(){let b=$(this).attr("href").split("id=");$(this).attr("href",b[0]+"id="+a)}),$("#id-hidden").val(a),$("#content-col").on("click",".open-notes",{object:this},this.openNotes),$("#keyboard-toggle").on("click",function(){keyboard.init()}),$("#content-col").on("click","#open-settings",function(){""===$.trim($("#modal-settings").find(".modal-body").html())&&$.when(model.load({url:window.IL_BASE_URL+"index.php/settings/display"})).done(function(a){$("#modal-settings").find(".modal-body").html(a.html),formStyle.init()})}),$("#modal-settings .modal-footer button").eq(0).on("click",function(a){$("#modal-settings form").trigger("submit")}),$("#modal-settings").on("submit","form",function(b){b.preventDefault();let a=$(this);$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){B.history.loadUrl()}),$("#modal-settings").modal("hide")}),$("#sign-out").on("click",function(){$.when(model.save({url:window.IL_BASE_URL+"index.php/authentication/signout"})).done(function(){location.assign(window.IL_BASE_URL)})}),searchlist.init()}openNotes(a){null!==window.tinymce.activeEditor&& !0===window.tinymce.activeEditor.initialized?$("#notes-window").removeClass("d-none"):a.data.object.loadNotes()}loadNotes(){let b=this,a=$("body").data("id");$.when(model.load({url:window.IL_BASE_URL+"index.php/project/usernotes",data:{id:a}})).done(function(a){$("#notes-ta").val(a.user.note),b.initNotes()})}initNotes(){window.tinymce.init({theme:"silver",selector:"#notes-ta",content_css:window.IL_BASE_URL+"css/style.css",resize:"both",min_width:300,min_height:300,menubar:!1,plugins:"importcss save lists advlist link image code fullscreen table searchreplace",toolbar1:"save undo redo fullscreen code | formatselect link unlink image table searchreplace",toolbar2:"bold italic underline strikethrough subscript superscript removeformat | forecolor backcolor | outdent indent bullist numlist",save_onsavecallback:function(b){let a=$("#note-form");$.when(model.save({url:a.attr("action"),data:a.serialize()})).done(function(){$("#user-note").html(b.getContent()),"function"==typeof window.MathJax.typeset&&window.MathJax.typeset()})},image_description:!1,relative_urls:!1,remove_script_host:!1,image_dimensions:!1,image_class_list:[{title:"Auto width",value:"mce-img-fluid"}]}).then(function(){let a=$("#notes-window");a.removeClass("d-none"),a.position({my:"left bottom",at:"left bottom",of:"#content-col"}),$(window).off("resize.notes").on("resize.notes",function(){$("#notes-window").position({my:"left bottom",at:"left bottom",of:"#content-col"})}),a.draggable({handle:".card-header",containment:"body"}),a.find(".close").off("click.notes").on("click.notes",function(){$("#notes-window").addClass("d-none")})})}}$(function(){B.history.start(),$("body").on("click","a",function(){let a=$(this).attr("href");return a.indexOf("//")>0||0===a.indexOf("mailto")||0===a.indexOf("data")?(!0===/\/item#/.test(a)&&store.save("il.itemReferrer",location.href),!0):"#"!==a&&""!==a&&void router.navigate(a,{trigger:!0})}),$("body").on("click","#abort-request",function(){model.abort()}),$(document).on("keydown.hotkeys",null,"a",function(){$(".navigation-left").trigger("click")}),$(document).on("keydown.hotkeys",null,"w",function(){$(".navigation-left").trigger("click")}),$(document).on("keydown.hotkeys",null,"d",function(){$(".navigation-right").trigger("click")}),$(document).on("keydown.hotkeys",null,"s",function(){$(".navigation-right").trigger("click")}),$(document).on("keydown.hotkeys",null,"esc",function(){1===$("#pdfviewer-menu").length&&"object"==typeof views.pdfmain&&(views.pdfmain.destroyCropper(),views.pdfmain.destroyTextLayer(),views.pdfmain.clearNewNote(),$("#pdfviewer-highlight-menu .highlight-cancel").click()),1===$("#pdfviewer-menu").length&&"object"==typeof window.pdfmainview&&(window.pdfmainview.destroyCropper(),window.pdfmainview.destroyTextLayer(),window.pdfmainview.clearNewNote(),$("#pdfviewer-highlight-menu .highlight-cancel").click())}),$(document).on("keydown.hotkeys",null,"h",function(){1===$("#pdfviewer-menu").length&&($(".left-container, #pdfviewer-menu").toggleClass("d-none"),$(window).trigger("resize.PdfMainView"))})})